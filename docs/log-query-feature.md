# 日志查询功能文档

## 概述

本文档描述了新增的日志查询功能，该功能允许用户通过Web界面查询和分析系统运行日志。

## 功能特性

### ✅ 已实现功能

1. **时间区间查询**
   - 支持开始时间和结束时间筛选
   - 默认查询最近1小时的日志
   - 时间格式：ISO 8601标准

2. **最大条数限制**
   - 默认返回200条记录
   - 可设置1-1000条记录
   - 防止大量数据影响性能

3. **日志级别过滤**
   - ERROR：错误日志
   - WARN：警告日志
   - INFO：信息日志
   - DEBUG：调试日志

4. **关键词搜索**
   - 支持在日志消息中搜索关键词
   - 不区分大小写

5. **多种日志格式支持**
   - Morgan HTTP访问日志
   - PM2进程日志
   - Console.log应用日志
   - 自定义时间戳格式

6. **统计信息显示**
   - 可用日志文件数量
   - 查询结果统计
   - 文件大小信息

## 技术实现

### 后端组件

#### LogManager类 (`src/services/log-manager.ts`)
- 单例模式管理日志查询
- 支持多种日志文件路径
- 智能日志格式解析
- 高效的流式文件读取

#### API接口 (`/api/logs`)
- GET请求支持查询参数
- 参数验证和错误处理
- JSON格式响应

### 前端组件

#### 日志查询页面 (`public/logs.html`)
- 响应式设计，支持移动端
- 实时查询和结果显示
- 用户友好的界面
- 错误处理和加载状态

## 使用方法

### 1. 访问日志查询页面

```
http://localhost:3000/logs
```

### 2. 设置查询条件

- **开始时间**：选择查询的起始时间
- **结束时间**：选择查询的结束时间
- **最大条数**：设置返回的最大记录数（1-1000）
- **日志级别**：选择要查看的日志级别
- **关键词**：输入要搜索的关键词

### 3. 查看结果

- 点击"查询日志"按钮执行查询
- 结果以表格形式显示
- 包含时间、级别、消息三列
- 支持按时间倒序排列

### 4. API直接调用

```bash
# 查询最近的10条日志
GET /api/logs?maxRecords=10

# 查询指定时间范围的错误日志
GET /api/logs?startTime=2025-01-02T10:00:00.000Z&endTime=2025-01-02T11:00:00.000Z&level=ERROR

# 搜索包含特定关键词的日志
GET /api/logs?keyword=error&maxRecords=50
```

## 日志文件路径

系统会自动搜索以下路径的日志文件：

1. **开发环境目录**
   - `./logs/combined.log`
   - `./logs/out.log`
   - `./logs/error.log`

2. **生产环境目录**
   - `../logs/combined.log`
   - `../logs/out.log`
   - `../logs/error.log`

3. **PM2日志轮转文件**
   - `../logs/combined-0.log`
   - `../logs/combined-0__2025-08-03_00-00-00.log`
   - `../logs/out-1__2025-08-02_23-59-59.log`
   - `../logs/error-2.log`
   - 支持任意格式的轮转文件名
   - 自动扫描所有匹配的轮转文件

4. **用户主目录**
   - `~/logs/combined.log`
   - `~/logs/out.log`
   - `~/logs/error.log`

## 支持的日志格式

### 1. Morgan HTTP访问日志
```
127.0.0.1 - - [02/Jan/2025:02:30:20 +0000] "GET /api/status HTTP/1.1" 200 245 "-" "Mozilla/5.0"
```

### 2. PM2进程日志
```
2025-01-02 10:30:15 +0800: ✅ Delta数据库已初始化
```

### 3. Console.log应用日志
```
2025-01-02T10:30:15.123Z 🚀 Deribit Options Trading Microservice running on port 3000
```

## PM2日志轮转支持

系统支持PM2的`pm2-logrotate`插件产生的轮转日志文件：

### 轮转文件格式
支持各种PM2日志轮转文件格式：
- `combined-0.log` - 标准轮转格式
- `combined-0__2025-08-03_00-00-00.log` - 带时间戳的轮转格式
- `out-1__2025-08-02_23-59-59.log` - 输出日志轮转
- `error-2.log` - 错误日志轮转
- 任何以 `combined-`、`out-`、`error-` 开头的 `.log` 文件

### 自动发现机制
1. **智能扫描**：自动扫描日志目录中的所有轮转文件
2. **灵活匹配**：只要文件名以 `combined-`、`out-`、`error-` 开头且以 `.log` 结尾即可
3. **时间排序**：按文件修改时间排序，优先读取最新文件
4. **类型识别**：支持combined、out、error三种类型的轮转文件
5. **去重处理**：避免重复读取相同的日志文件

### 配置建议
```bash
# 安装PM2日志轮转插件
pm2 install pm2-logrotate

# 配置轮转参数
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 7
pm2 set pm2-logrotate:compress true
```

## 性能优化

1. **流式读取**：使用readline逐行读取，避免内存溢出
2. **时间过滤**：在读取过程中进行时间筛选，减少内存使用
3. **结果限制**：最大1000条记录限制，防止响应过大
4. **缓存机制**：文件状态检查缓存，提高查询效率
5. **轮转文件优化**：优先读取最新的轮转文件，提高查询效率

## 错误处理

1. **参数验证**：检查时间格式和数值范围
2. **文件访问**：处理文件不存在或权限问题
3. **网络错误**：前端自动重试和错误提示
4. **格式解析**：容错处理未知日志格式

## 安全考虑

1. **参数限制**：最大条数限制防止DoS攻击
2. **路径安全**：只访问预定义的日志文件路径
3. **输入验证**：所有用户输入都经过验证和转义

## 扩展功能建议

### 🚧 未来可能的改进

1. **实时日志流**：WebSocket支持实时日志推送
2. **日志下载**：支持导出查询结果为文件
3. **高级过滤**：正则表达式搜索支持
4. **日志聚合**：按时间段统计和图表显示
5. **用户权限**：不同用户访问不同日志文件
6. **日志轮转**：自动清理过期日志文件

## 故障排除

### 常见问题

1. **找不到日志文件**
   - 检查logs目录是否存在
   - 确认日志文件权限
   - 查看服务器启动日志

2. **查询结果为空**
   - 检查时间范围设置
   - 确认日志级别筛选
   - 验证关键词拼写

3. **页面加载失败**
   - 确认服务器运行状态
   - 检查网络连接
   - 查看浏览器控制台错误

### 调试方法

1. **查看服务器日志**：检查API调用是否成功
2. **浏览器开发者工具**：查看网络请求和JavaScript错误
3. **API直接测试**：使用curl或浏览器直接访问API

## 总结

日志查询功能为Deribit期权交易系统提供了强大的日志分析能力，支持灵活的查询条件和用户友好的界面。该功能有助于：

- 快速定位系统问题
- 分析交易行为模式
- 监控系统运行状态
- 调试和故障排除

通过Web界面的直观操作，用户可以轻松查询和分析系统日志，提高运维效率和问题解决速度。
