# Deribit Options Trading Microservice

ä¸€ä¸ªåŸºäº Node.js + TypeScript çš„ Deribit æœŸæƒäº¤æ˜“å¾®æœåŠ¡ï¼Œå®ç°äº†å®Œæ•´çš„ OAuth 2.0 è®¤è¯å’ŒæœŸæƒäº¤æ˜“åŠŸèƒ½ã€‚

## ğŸ“‹ åŠŸèƒ½ç‰¹æ€§

- âœ… **OAuth 2.0 è®¤è¯** - æ”¯æŒ client_credentials æˆæƒæ¨¡å¼
- âœ… **å¤šè´¦æˆ·ç®¡ç†** - æ”¯æŒå¤šä¸ª API å¯†é’¥é…ç½®
- âœ… **æµ‹è¯•/ç”Ÿäº§ç¯å¢ƒ** - è‡ªåŠ¨åˆ‡æ¢æµ‹è¯•å’Œç”Ÿäº§ç¯å¢ƒ
- âœ… **ä»¤ç‰Œç®¡ç†** - è‡ªåŠ¨ä»¤ç‰Œåˆ·æ–°å’Œè¿‡æœŸå¤„ç†
- âœ… **æœŸæƒäº¤æ˜“ API** - å®Œæ•´çš„æœŸæƒäº¤æ˜“æ¥å£
- âœ… **Mock æ¨¡å¼** - å¼€å‘æµ‹è¯•æ¨¡å¼ï¼Œæ— éœ€ç½‘ç»œè¿æ¥
- âœ… **Delta ç®¡ç†** - æœŸæƒ Delta é£é™©ç®¡ç†å’Œä»“ä½è°ƒæ•´
- âœ… **ä¼ä¸šå¾®ä¿¡é€šçŸ¥** - äº¤æ˜“ç»“æœå’ŒçŠ¶æ€é€šçŸ¥
- âœ… **åå°è½®è¯¢** - è‡ªåŠ¨ç›‘æ§ä»“ä½å’Œè°ƒæ•´ç­–ç•¥
- âœ… **é”™è¯¯å¤„ç†** - å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
npm install
```

### 2. é…ç½® API å¯†é’¥

å¤åˆ¶å¹¶ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼š

```bash
cp config/apikeys.example.yml config/apikeys.yml
```

ç¼–è¾‘ `config/apikeys.yml`ï¼Œå¡«å…¥ä½ çš„ Deribit API å‡­æ®ï¼š

```yaml
accounts:
  - name: account_1
    description: "Primary trading account"
    clientId: "your_client_id_here"
    clientSecret: "your_client_secret_here"
    enabled: true
    testMode: true
    grantType: "client_credentials"
```

### 3. ç¯å¢ƒé…ç½®

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```env
PORT=3000
USE_MOCK_MODE=true  # å¼€å‘æ¨¡å¼ä½¿ç”¨mock
USE_TEST_ENVIRONMENT=true
```

### 4. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼
npm run dev

# ç”Ÿäº§æ¨¡å¼
npm run build
npm start
```

## ğŸ“¡ API æ¥å£

### æ ¸å¿ƒæ¥å£

- **`POST /webhook/signal`** - TradingView webhook ä¿¡å·æ¥æ”¶ (ä¸»è¦åŠŸèƒ½)
- **`GET /api/trading/status`** - äº¤æ˜“æœåŠ¡çŠ¶æ€

### Delta ç®¡ç†æ¥å£

- **`GET /api/delta/:account`** - è·å–è´¦æˆ· Delta è®°å½•
- **`POST /api/delta/:account`** - åˆ›å»º Delta è®°å½•
- **`PUT /api/delta/:account/:id`** - æ›´æ–° Delta è®°å½•
- **`DELETE /api/delta/:account/:id`** - åˆ é™¤ Delta è®°å½•
- **`GET /api/delta/:account/live-data`** - è·å–å®æ—¶ä»“ä½å’Œè®¢å•æ•°æ®

### ä»“ä½ç®¡ç†æ¥å£

- **`GET /api/positions/:account/:currency`** - è·å–æŒ‡å®šè´§å¸ä»“ä½
- **`POST /api/positions/:account/adjust`** - è°ƒæ•´ä»“ä½

### ç³»ç»Ÿæ¥å£

- **`GET /health`** - å¥åº·æ£€æŸ¥
- **`GET /api/status`** - æœåŠ¡çŠ¶æ€
- **`GET /api/auth/test`** - è®¤è¯æµ‹è¯•
- **`GET /api/instruments`** - è·å–æœŸæƒå·¥å…·
- **`GET /api/account/:currency`** - è·å–è´¦æˆ·ä¿¡æ¯

è¯¦ç»†çš„ Webhook API æ–‡æ¡£è¯·å‚è€ƒï¼š`WEBHOOK_API.md`

## ğŸ”§ å¼€å‘æ¨¡å¼

é¡¹ç›®æ”¯æŒ Mock æ¨¡å¼ï¼Œåœ¨ç½‘ç»œå—é™ç¯å¢ƒä¸‹å¯ä»¥è¿›è¡Œå¼€å‘æµ‹è¯•ï¼š

1. è®¾ç½® `USE_MOCK_MODE=true` åœ¨ `.env` æ–‡ä»¶ä¸­
2. Mock æ¨¡å¼ä¼šæ¨¡æ‹Ÿæ‰€æœ‰ Deribit API å“åº”
3. æ”¯æŒå®Œæ•´çš„è®¤è¯æµç¨‹æµ‹è¯•

## ğŸ¯ Delta ç®¡ç†ç³»ç»Ÿ

Delta ç®¡ç†ç³»ç»Ÿæ˜¯æœ¬é¡¹ç›®çš„æ ¸å¿ƒåŠŸèƒ½ï¼Œç”¨äºæœŸæƒäº¤æ˜“çš„é£é™©ç®¡ç†ï¼š

### Delta æ¦‚å¿µ
- **ç›®æ ‡Delta(2)**ï¼šæœŸæœ›è¾¾åˆ°çš„ Delta å€¼ï¼Œç”¨äºç­–ç•¥è§„åˆ’
- **ç§»ä»“Delta(1)**ï¼šåœ¨ä»“ä½è°ƒæ•´è¿‡ç¨‹ä¸­è¦è¾¾æˆçš„ Delta å€¼
- **Delta å€¼èŒƒå›´**ï¼š-1 åˆ° 1ï¼Œæ­£å€¼ä¸ºçœ‹æ¶¨ï¼Œè´Ÿå€¼ä¸ºçœ‹è·Œ

### ç®¡ç†åŠŸèƒ½
- **æ•°æ®åº“è®°å½•**ï¼šæŒä¹…åŒ–å­˜å‚¨ Delta é…ç½®
- **å®æ—¶ç›‘æ§**ï¼šé€šè¿‡å‰ç«¯é¡µé¢ç›‘æ§å®é™… Delta æ•å£
- **è‡ªåŠ¨è°ƒæ•´**ï¼šåå°è½®è¯¢æœåŠ¡è‡ªåŠ¨è°ƒæ•´ä»“ä½
- **Webhook é›†æˆ**ï¼šä¸ TradingView ç­–ç•¥ä¿¡å·é›†æˆ

### å‰ç«¯é¡µé¢
- **`/`** - ä¸»æ§åˆ¶å°ï¼šç³»ç»Ÿæ¦‚è§ˆå’ŒçŠ¶æ€ç›‘æ§
- **`/delta-manager.html`** - Delta ç®¡ç†å™¨ï¼šDelta è®°å½•ç®¡ç†å’Œè°ƒæ•´
- **`/logs.html`** - æ—¥å¿—æŸ¥çœ‹å™¨ï¼šç³»ç»Ÿæ—¥å¿—å’Œå†å²è®°å½•

## ğŸ“ é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ config/              # é…ç½®åŠ è½½å™¨å’Œç¯å¢ƒå˜é‡ç®¡ç†
â”œâ”€â”€ core/                # æ ¸å¿ƒä¾èµ–æ³¨å…¥å®¹å™¨
â”‚   â”œâ”€â”€ di-container.ts    # ä¾èµ–æ³¨å…¥å®¹å™¨å®ç°
â”‚   â”œâ”€â”€ service-registry.ts # æœåŠ¡æ³¨å†Œé…ç½®
â”‚   â””â”€â”€ service-tokens.ts   # æœåŠ¡ä»¤ç‰Œå®šä¹‰
â”œâ”€â”€ services/            # ä¸šåŠ¡æœåŠ¡å±‚
â”‚   â”œâ”€â”€ auth.ts            # Deribit OAuth 2.0 è®¤è¯
â”‚   â”œâ”€â”€ deribit-client.ts  # Deribit API å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ mock-deribit.ts    # Mock å®¢æˆ·ç«¯ï¼ˆå¼€å‘ç”¨ï¼‰
â”‚   â”œâ”€â”€ option-service.ts  # æœŸæƒäº¤æ˜“æœåŠ¡
â”‚   â”œâ”€â”€ option-trading.ts  # æœŸæƒäº¤æ˜“é€»è¾‘
â”‚   â””â”€â”€ wechat-notification.ts # ä¼ä¸šå¾®ä¿¡é€šçŸ¥
â”œâ”€â”€ routes/              # Express è·¯ç”±å¤„ç†å™¨
â”‚   â”œâ”€â”€ webhook.ts         # TradingView webhook æ¥å£
â”‚   â”œâ”€â”€ delta.ts           # Delta ç®¡ç† API
â”‚   â”œâ”€â”€ trading.ts         # äº¤æ˜“ API
â”‚   â”œâ”€â”€ positions.ts       # ä»“ä½ç®¡ç† API
â”‚   â”œâ”€â”€ auth.ts            # è®¤è¯ API
â”‚   â””â”€â”€ health.ts          # å¥åº·æ£€æŸ¥ API
â”œâ”€â”€ middleware/           # Express ä¸­é—´ä»¶
â”‚   â”œâ”€â”€ error-handler.ts   # å…¨å±€é”™è¯¯å¤„ç†
â”‚   â””â”€â”€ account-validation.ts # è´¦æˆ·éªŒè¯
â”œâ”€â”€ database/            # SQLite æ•°æ®åº“ç®¡ç†
â”‚   â”œâ”€â”€ delta-manager.ts    # Delta è®°å½•æ•°æ®åº“ç®¡ç†
â”‚   â””â”€â”€ types.ts           # æ•°æ®åº“ç±»å‹å®šä¹‰
â”œâ”€â”€ polling/             # åå°è½®è¯¢æœåŠ¡
â”‚   â”œâ”€â”€ position-poller.ts  # ä»“ä½ç›‘æ§è½®è¯¢
â”‚   â””â”€â”€ polling-manager.ts # è½®è¯¢ç®¡ç†å™¨
â”œâ”€â”€ jobs/                # å®šæ—¶ä»»åŠ¡
â”‚   â””â”€â”€ delta-cleanup.ts    # Delta è®°å½•æ¸…ç†ä»»åŠ¡
â”œâ”€â”€ utils/               # å·¥å…·å‡½æ•°
â”‚   â”œâ”€â”€ response-formatter.ts # API å“åº”æ ¼å¼åŒ–
â”‚   â”œâ”€â”€ spread-calculation.ts # ä»·å·®è®¡ç®—
â”‚   â””â”€â”€ price-correction.ts  # ä»·æ ¼ä¿®æ­£
â”œâ”€â”€ types/               # TypeScript ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ deribit-instrument.ts # Deribit å·¥å…·ç±»å‹
â”‚   â”œâ”€â”€ position-info.ts     # ä»“ä½ä¿¡æ¯ç±»å‹
â”‚   â””â”€â”€ index.ts            # é€šç”¨ç±»å‹
â”œâ”€â”€ api/                 # API å®¢æˆ·ç«¯å®ç°
â”‚   â”œâ”€â”€ deribit-private.ts  # Deribit ç§æœ‰ API
â”‚   â”œâ”€â”€ deribit-public.ts   # Deribit å…¬å¼€ API
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ factory/             # å·¥å‚æ¨¡å¼å®ç°
â”‚   â””â”€â”€ client-factory.ts   # å®¢æˆ·ç«¯å·¥å‚
â”œâ”€â”€ app.ts               # Express åº”ç”¨é…ç½®
â””â”€â”€ index.ts             # ä¸»å…¥å£æ–‡ä»¶

public/                  # å‰ç«¯é¡µé¢
â”œâ”€â”€ index.html           # ä¸»æ§åˆ¶å°é¡µé¢
â”œâ”€â”€ delta-manager.html   # Delta ç®¡ç†å™¨é¡µé¢
â””â”€â”€ logs.html            # æ—¥å¿—æŸ¥çœ‹å™¨é¡µé¢

config/                  # é…ç½®æ–‡ä»¶
â”œâ”€â”€ apikeys.yml          # API å¯†é’¥é…ç½®ï¼ˆéœ€è‡ªè¡Œåˆ›å»ºï¼‰
â””â”€â”€ apikeys.example.yml  # API å¯†é’¥é…ç½®æ¨¡æ¿

data/                    # SQLite æ•°æ®åº“æ–‡ä»¶
â””â”€â”€ delta_records.db     # Delta è®°å½•æ•°æ®åº“
```

## ğŸ” å®‰å…¨è¯´æ˜

- API å¯†é’¥æ–‡ä»¶ `config/apikeys.yml` å·²åŠ å…¥ `.gitignore`
- ç”Ÿäº§ç¯å¢ƒè¯·è®¾ç½® `USE_TEST_ENVIRONMENT=false`
- ç”Ÿäº§ç¯å¢ƒè¯·è®¾ç½® `USE_MOCK_MODE=false`
- å»ºè®®ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†æ•æ„Ÿä¿¡æ¯
- ä¼ä¸šå¾®ä¿¡ Webhook URL è¯·å¦¥å–„ä¿ç®¡
- æ•°æ®åº“æ–‡ä»¶ `data/` ç›®å½•å·²åŠ å…¥ `.gitignore`

## ğŸ“š è¯¦ç»†æ–‡æ¡£

- **Webhook API æ–‡æ¡£**: `WEBHOOK_API.md` - åŒ…å« Deribit API å‚è€ƒå’Œ Webhook é›†æˆæŒ‡å—
- **å¿«é€Ÿå¼€å§‹**: `QUICK_START.md` - å¿«é€Ÿéƒ¨ç½²æŒ‡å—
- **å¼€å‘è€…æŒ‡å—**: `AGENTS.md` - AI å¼€å‘äººå‘˜æŒ‡å—å’Œæ¶æ„æ–‡æ¡£
- **æ¥å£éœ€æ±‚**: `æ¥å£éœ€æ±‚.md` - é¡¹ç›®æ¥å£éœ€æ±‚è¯´æ˜

## ğŸ¯ å·²å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

1. **OAuth 2.0 è®¤è¯æµç¨‹** âœ…
2. **Token è‡ªåŠ¨åˆ·æ–°** âœ…
3. **å¤šè´¦æˆ·æ”¯æŒ** âœ…
4. **Webhook ä¿¡å·æ¥æ”¶** âœ…
5. **äº¤æ˜“ä¿¡å·è§£æ** âœ…
6. **æœŸæƒåˆçº¦è‡ªåŠ¨é€‰æ‹©** âœ…
7. **çœŸå®äº¤æ˜“æ‰§è¡Œ** âœ…
8. **Delta é£é™©ç®¡ç†ç³»ç»Ÿ** âœ…
9. **ä¼ä¸šå¾®ä¿¡é€šçŸ¥ç³»ç»Ÿ** âœ…
10. **åå°ä»“ä½è½®è¯¢æœåŠ¡** âœ…
11. **SQLite Delta æ•°æ®åº“** âœ…
12. **å‰ç«¯ç®¡ç†ç•Œé¢** âœ…
13. **WebSocket å®æ—¶æ•°æ®è®¢é˜…** âœ… (éƒ¨åˆ†å®ç°)
14. **å®Œæ•´çš„è®¢å•ç®¡ç†ç³»ç»Ÿ** âœ…
15. **é£é™©ç®¡ç†å’Œä»“ä½æ§åˆ¶** âœ…
16. **æ—¥å¿—ç³»ç»Ÿå’Œç›‘æ§** âœ…
17. **Mock æ¨¡å¼å¼€å‘** âœ…
18. **é…ç½®æ–‡ä»¶ç®¡ç†** âœ…

## ğŸš§ å¾…å®ç°åŠŸèƒ½

- [ ] å®Œæ•´çš„ WebSocket å®æ—¶æ•°æ®è®¢é˜…
- [ ] é«˜çº§æœŸæƒäº¤æ˜“ç­–ç•¥å®ç°
- [ ] æ›´å®Œå–„çš„é£é™©æ§åˆ¶ç®—æ³•
- [ ] æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜æœºåˆ¶
- [ ] æ›´å¤šäº¤æ˜“æ‰€æ”¯æŒ
- [ ] å›¾è¡¨å’Œåˆ†æåŠŸèƒ½
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–æå‡

## ğŸ“„ License

MIT
