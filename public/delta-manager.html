<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deltaç®¡ç†å™¨ - DeribitæœŸæƒäº¤æ˜“</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“Š</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ“Š</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .account-selector {
            margin: 20px 0;
        }

        .account-selector select {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            color: #2c3e50;
            cursor: pointer;
        }

        .main-content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .stat-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .stat-subtitle {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .table-container {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #e3f2fd;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .section-title > div {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #currencySelect {
            border: 2px solid #3498db;
            border-radius: 5px;
            background: white;
            color: #2c3e50;
            font-size: 14px;
        }

        #currencySelect:focus {
            outline: none;
            border-color: #2980b9;
        }

        .form-group label span {
            color: #e74c3c;
            font-weight: bold;
        }

        .form-group input:required {
            border-left: 3px solid #e74c3c;
        }

        .form-group input:required:valid {
            border-left: 3px solid #27ae60;
        }

        /* æ•°æ®éªŒè¯çŠ¶æ€æ ·å¼ */
        .status-valid {
            color: #27ae60;
            font-weight: bold;
        }

        .status-invalid {
            color: #e74c3c;
            font-weight: bold;
            cursor: help;
        }

        .status-unknown {
            color: #f39c12;
            font-weight: bold;
        }

        .invalid-record {
            background-color: #fdf2f2;
            border-left: 4px solid #e74c3c;
        }

        .invalid-record:hover {
            background-color: #fce4e4;
        }

        .btn-info {
            background: #3498db;
            color: white;
            font-size: 12px;
            padding: 5px 10px;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .delta-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .delta-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            background: #2980b9;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- å¼•å…¥ axios åº“ - å¤šä¸ªå¤‡ç”¨ CDN -->
    <script>
        // å°è¯•å¤šä¸ª CDN æº
        const cdnUrls = [
            'https://unpkg.com/axios@1.6.0/dist/axios.min.js',
            'https://cdn.bootcdn.net/ajax/libs/axios/1.6.0/axios.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js'
        ];

        let currentCdnIndex = 0;

        function loadAxios() {
            if (currentCdnIndex >= cdnUrls.length) {
                console.error('æ‰€æœ‰ axios CDN éƒ½åŠ è½½å¤±è´¥ï¼Œå°†ä½¿ç”¨ fetch ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ');
                return;
            }

            const script = document.createElement('script');
            script.src = cdnUrls[currentCdnIndex];
            script.onload = function() {
                console.log(`axios åŠ è½½æˆåŠŸï¼Œä½¿ç”¨ CDN: ${cdnUrls[currentCdnIndex]}`);
            };
            script.onerror = function() {
                console.warn(`CDN åŠ è½½å¤±è´¥: ${cdnUrls[currentCdnIndex]}`);
                currentCdnIndex++;
                loadAxios();
            };
            document.head.appendChild(script);
        }

        loadAxios();
    </script>
    <div class="container">
        <div class="header">
            <h1>ğŸ¯ Deltaç®¡ç†å™¨</h1>
            <p>DeribitæœŸæƒä»“ä½å’Œè®¢å•Deltaç®¡ç†</p>
            
            <div class="account-selector">
                <label for="accountSelect" style="margin-right: 10px;">é€‰æ‹©è´¦æˆ·:</label>
                <select id="accountSelect">
                    <option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>
                </select>
            </div>
        </div>

        <div class="main-content">
            <div id="loadingMessage" class="loading">
                <h3>ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ®...</h3>
            </div>

            <div id="errorMessage" class="error" style="display: none;"></div>
            <div id="successMessage" class="success" style="display: none;"></div>

            <div id="mainContent" style="display: none;">
                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>æ€»Delta</h3>
                        <div class="value" id="totalDelta">0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>ä»“ä½Delta</h3>
                        <div class="value" id="positionDelta">0.00</div>
                        <div class="stat-subtitle" id="positionCount">0ä¸ªä»“ä½</div>
                    </div>
                    <div class="stat-card">
                        <h3>è®¢å•æ•°é‡</h3>
                        <div class="value" id="orderCount">0</div>
                        <div class="stat-subtitle">è®¢å•æ— Deltaå€¼</div>
                    </div>
                    <div class="stat-card">
                        <h3>è®°å½•æ•°é‡</h3>
                        <div class="value" id="recordCount">0</div>
                        <div class="stat-subtitle" id="recordBreakdown">ä»“ä½: 0 | è®¢å•: 0</div>
                    </div>
                </div>

                <!-- æ•°æ®åº“ä¸­çš„ä»“ä½è®°å½• -->
                <div class="section">
                    <div class="section-title">
                        ğŸ“Š æ•°æ®åº“ä»“ä½è®°å½•
                        <div style="float: right;">
                            <button class="btn btn-primary" data-action="refresh-all" id="refreshAllBtn">
                                ğŸ”„ åˆ·æ–°æ‰€æœ‰
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="positionRecordsTable">
                            <thead>
                                <tr>
                                    <th>çŠ¶æ€</th>
                                    <th>åˆçº¦åç§°</th>
                                    <th>ç›®æ ‡Delta</th>
                                    <th>ç§»ä»“Delta</th>
                                    <th>æœ€å°åˆ°æœŸå¤©æ•°</th>
                                    <th>Deltaå¹³å‡å€¼</th>
                                    <th>TV_ID</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ›´æ–°æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- æ•°æ®åº“ä¸­çš„è®¢å•è®°å½• -->
                <div class="section">
                    <div class="section-title">
                        ğŸ“‹ æ•°æ®åº“è®¢å•è®°å½•
                    </div>
                    <div class="table-container">
                        <table id="orderRecordsTable">
                            <thead>
                                <tr>
                                    <th>çŠ¶æ€</th>
                                    <th>è®¢å•ID</th>
                                    <th>åˆçº¦åç§°</th>
                                    <th>ç›®æ ‡Delta</th>
                                    <th>ç§»ä»“Delta</th>
                                    <th>æœ€å°åˆ°æœŸå¤©æ•°</th>
                                    <th>TV_ID</th>
                                    <th>åˆ›å»ºæ—¶é—´</th>
                                    <th>æ›´æ–°æ—¶é—´</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- å®é™…ä»“ä½ -->
                <div class="section">
                    <div class="section-title">
                        ğŸ¦ å®é™…ä»“ä½ (æ‰€æœ‰å“ç§æœŸæƒ)
                        <div style="float: right;">
                            <button class="btn btn-primary" data-action="refresh-live" id="refreshBtn">
                                ğŸ”„ åˆ·æ–°
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="positionsTable">
                            <thead>
                                <tr>
                                    <th>åˆçº¦åç§°</th>
                                    <th>æ•°é‡</th>
                                    <th>æ–¹å‘</th>
                                    <th>å¹³å‡ä»·æ ¼</th>
                                    <th>æ ‡è®°ä»·æ ¼</th>
                                    <th>Deltaå€¼</th>
                                    <th>Deltaå¹³å‡å€¼</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- æœªæˆäº¤è®¢å• -->
                <div class="section">
                    <div class="section-title">
                        ğŸ“‹ æœªæˆäº¤è®¢å• (æœªè®°å½•åœ¨æ•°æ®åº“ä¸­)
                    </div>
                    <div class="table-container">
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>è®¢å•ID</th>
                                    <th>åˆçº¦åç§°</th>
                                    <th>æ–¹å‘</th>
                                    <th>æ•°é‡</th>
                                    <th>ä»·æ ¼</th>
                                    <th>ç±»å‹</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ /ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
    <div id="recordModal" class="modal">
        <div class="modal-content">
            <span class="close" data-action="close-modal">&times;</span>
            <h2 id="modalTitle">æ·»åŠ Deltaè®°å½•</h2>
            <form id="recordForm">
                <div class="form-group">
                    <label for="instrumentName">åˆçº¦åç§°:</label>
                    <input type="text" id="instrumentName" required>
                </div>
                <div class="form-group">
                    <label for="targetDeltaValue">ç›®æ ‡Deltaå€¼:</label>
                    <input type="number" id="targetDeltaValue" step="0.01" min="-1" max="1" required>
                </div>
                <div class="form-group">
                    <label for="tvId">TV_ID:</label>
                    <input type="number" id="tvId" required>
                </div>
                <div class="form-group">
                    <label for="recordType">è®°å½•ç±»å‹:</label>
                    <select id="recordType" required>
                        <option value="position">ä»“ä½</option>
                        <option value="order">è®¢å•</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderId">è®¢å•ID (å¯é€‰):</label>
                    <input type="text" id="orderId">
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-danger" data-action="close-modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- å¿«é€Ÿæ·»åŠ æ¨¡æ€æ¡† -->
    <div id="quickAddModal" class="modal">
        <div class="modal-content">
            <span class="close" data-action="close-quick-add">&times;</span>
            <h2 id="quickAddTitle">æ·»åŠ åˆ°æ•°æ®åº“</h2>
            <form id="quickAddForm">
                <div class="form-group">
                    <label for="quickInstrumentName">åˆçº¦åç§°:</label>
                    <input type="text" id="quickInstrumentName" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group" id="quickTargetDeltaGroup">
                    <label for="quickTargetDeltaValue">ç›®æ ‡Deltaå€¼ <span style="color: red;">*</span>:</label>
                    <input type="number" id="quickTargetDeltaValue" step="0.0001" min="-1" max="1" placeholder="è¯·è¾“å…¥ç›®æ ‡Deltaå€¼ (-1åˆ°1ä¹‹é—´)" required>
                    <small style="color: #666; font-size: 12px;">ä»“ä½å’Œè®¢å•éƒ½éœ€è¦è®¾ç½®ç›®æ ‡Deltaå€¼</small>
                </div>
                <div class="form-group" id="quickMovePositionDeltaGroup">
                    <label for="quickMovePositionDeltaValue">ç§»ä»“Deltaå€¼ <span style="color: red;">*</span>:</label>
                    <input type="number" id="quickMovePositionDeltaValue" step="0.0001" min="-1" max="1" placeholder="è¯·è¾“å…¥ç§»ä»“Deltaå€¼ (-1åˆ°1ä¹‹é—´)" required>
                    <small style="color: #666; font-size: 12px;">ä»“ä½å’Œè®¢å•éƒ½éœ€è¦è®¾ç½®ç§»ä»“Deltaå€¼</small>
                </div>
                <div class="form-group">
                    <label for="quickMinExpireDays">æœ€å°åˆ°æœŸå¤©æ•° (å¯ç•™ç©º):</label>
                    <input type="number" id="quickMinExpireDays" min="1" step="1" placeholder="è¯·è¾“å…¥æœ€å°åˆ°æœŸå¤©æ•° (å¤§äº0çš„æ•´æ•°ï¼Œå¯ç•™ç©º)">
                    <small style="color: #666; font-size: 12px;">ç”¨äºæœŸæƒé€‰æ‹©çš„æœ€å°åˆ°æœŸå¤©æ•°ï¼Œç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶</small>
                </div>
                <div class="form-group">
                    <label for="quickTvId">TV_ID (å¯ç•™ç©º):</label>
                    <input type="number" id="quickTvId" placeholder="å¯é€‰çš„TradingViewä¿¡å·ID">
                </div>
                <div class="form-group" id="quickOrderIdGroup" style="display: none;">
                    <label for="quickOrderId">è®¢å•ID:</label>
                    <input type="text" id="quickOrderId" readonly style="background: #f5f5f5;">
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-danger" data-action="close-quick-add">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">æ·»åŠ åˆ°æ•°æ®åº“</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" data-action="close-edit">&times;</span>
            <h2 id="editModalTitle">ç¼–è¾‘è®°å½•</h2>
            <form id="editForm">
                <div class="form-group">
                    <label for="editInstrumentName">åˆçº¦åç§°:</label>
                    <input type="text" id="editInstrumentName" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group" id="editTargetDeltaGroup">
                    <label for="editTargetDeltaValue">ç›®æ ‡Deltaå€¼:</label>
                    <input type="number" id="editTargetDeltaValue" step="0.0001" min="-1" max="1" required>
                </div>
                <div class="form-group" id="editMovePositionDeltaGroup">
                    <label for="editMovePositionDeltaValue">ç§»ä»“Deltaå€¼:</label>
                    <input type="number" id="editMovePositionDeltaValue" step="0.0001" min="-1" max="1" required>
                </div>
                <div class="form-group">
                    <label for="editMinExpireDays">æœ€å°åˆ°æœŸå¤©æ•° (å¯ç•™ç©º):</label>
                    <input type="number" id="editMinExpireDays" min="1" step="1" placeholder="ç•™ç©ºè¡¨ç¤ºä¸é™åˆ¶">
                </div>
                <div class="form-group">
                    <label for="editTvId">TV_ID (å¯ç•™ç©º):</label>
                    <input type="number" id="editTvId" placeholder="å¯é€‰çš„TradingViewä¿¡å·ID">
                </div>
                <div class="form-group" id="editOrderIdGroup" style="display: none;">
                    <label for="editOrderId">è®¢å•ID:</label>
                    <input type="text" id="editOrderId" readonly style="background: #f5f5f5;">
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-danger" data-action="close-edit">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-success">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- åˆ·æ–°æŒ‰é’® -->
    <button class="refresh-btn" data-action="load-data" title="åˆ·æ–°æ•°æ®">
        ğŸ”„
    </button>

    <script>
        // åˆ›å»ºç»Ÿä¸€çš„ HTTP å®¢æˆ·ç«¯ï¼ˆæ”¯æŒ axios å’Œ fetch å¤‡ç”¨æ–¹æ¡ˆï¼‰
        const httpClient = {
            async get(url) {
                if (typeof axios !== 'undefined') {
                    return await axios.get(url);
                } else {
                    console.warn('axios æœªåŠ è½½ï¼Œä½¿ç”¨ fetch å¤‡ç”¨æ–¹æ¡ˆ');
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return { data: await response.json() };
                }
            },

            async post(url, data) {
                if (typeof axios !== 'undefined') {
                    return await axios.post(url, data);
                } else {
                    console.warn('axios æœªåŠ è½½ï¼Œä½¿ç”¨ fetch å¤‡ç”¨æ–¹æ¡ˆ');
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return { data: await response.json() };
                }
            },

            async put(url, data) {
                if (typeof axios !== 'undefined') {
                    return await axios.put(url, data);
                } else {
                    console.warn('axios æœªåŠ è½½ï¼Œä½¿ç”¨ fetch å¤‡ç”¨æ–¹æ¡ˆ');
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return { data: await response.json() };
                }
            }
        };

        // å¦‚æœ axios åŠ è½½æˆåŠŸï¼Œé…ç½®é»˜è®¤è®¾ç½®
        setTimeout(() => {
            if (typeof axios !== 'undefined') {
                axios.defaults.timeout = 30000; // 30ç§’è¶…æ—¶
                axios.defaults.headers.common['Content-Type'] = 'application/json';

                // axios å“åº”æ‹¦æˆªå™¨ï¼Œç»Ÿä¸€å¤„ç†é”™è¯¯
                axios.interceptors.response.use(
                    response => response,
                    error => {
                        if (error.response) {
                            // æœåŠ¡å™¨è¿”å›é”™è¯¯çŠ¶æ€ç 
                            let message = error.response.data?.message || `HTTP ${error.response.status}: ${error.response.statusText}`;

                            // ç‰¹æ®Šå¤„ç†è´¦æˆ·ä¸å­˜åœ¨çš„é”™è¯¯
                            if (error.response.status === 404 && message.includes('Account not found')) {
                                const accountName = message.split(': ')[1];
                                message = `è´¦æˆ· "${accountName}" ä¸å­˜åœ¨ã€‚å¯ç”¨è´¦æˆ·: ${availableAccounts.join(', ')}`;
                            }

                            throw new Error(message);
                        } else if (error.request) {
                            // è¯·æ±‚å‘å‡ºä½†æ²¡æœ‰æ”¶åˆ°å“åº”
                            throw new Error('ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–æœåŠ¡å™¨çŠ¶æ€');
                        } else {
                            // å…¶ä»–é”™è¯¯
                            throw new Error(error.message);
                        }
                    }
                );
                console.log('axios é…ç½®å®Œæˆ');
            }
        }, 1000); // ç­‰å¾…1ç§’ç¡®ä¿ axios åŠ è½½å®Œæˆ

        // å…¨å±€å˜é‡
        let currentAccount = '';
        let deltaRecords = [];
        let livePositions = [];
        let liveOrders = [];
        let editingRecordId = null;
        let validatedRecords = []; // å­˜å‚¨éªŒè¯åçš„è®°å½•

        // å¯ç”¨è´¦æˆ·åˆ—è¡¨ - ä»APIåŠ¨æ€è·å–
        let availableAccounts = [];

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            // æ˜¾ç¤ºåˆå§‹åŒ–çŠ¶æ€
            showLoading('æ­£åœ¨åˆå§‹åŒ–è´¦æˆ·åˆ—è¡¨...');

            // å…ˆåŠ è½½è´¦æˆ·åˆ—è¡¨ï¼Œå†å¤„ç†URLå‚æ•°
            await loadAccounts();

            // ä»URLå‚æ•°è·å–è´¦æˆ·ID
            const urlParams = new URLSearchParams(window.location.search);
            const accountId = urlParams.get('account');
            if (accountId) {
                // æ£€æŸ¥è´¦æˆ·æ˜¯å¦å­˜åœ¨
                if (availableAccounts.length > 0 && availableAccounts.includes(accountId)) {
                    document.getElementById('accountSelect').value = accountId;
                    selectAccount(accountId);
                } else if (availableAccounts.length > 0) {
                    // è´¦æˆ·ä¸å­˜åœ¨ï¼Œæ˜¾ç¤ºé”™è¯¯å¹¶æ¸…ç†URL
                    showError(`URLä¸­æŒ‡å®šçš„è´¦æˆ· "${accountId}" ä¸å­˜åœ¨ã€‚å¯ç”¨è´¦æˆ·: ${availableAccounts.join(', ')}`);
                    const url = new URL(window.location);
                    url.searchParams.delete('account');
                    window.history.replaceState({}, '', url);
                } else {
                    // æ²¡æœ‰å¯ç”¨è´¦æˆ·ï¼Œæ¸…ç†URLä½†ä¸æ˜¾ç¤ºè´¦æˆ·ä¸å­˜åœ¨çš„é”™è¯¯
                    const url = new URL(window.location);
                    url.searchParams.delete('account');
                    window.history.replaceState({}, '', url);
                }
            }

            // æ·»åŠ é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                // Ctrl+R æˆ– F5: åˆ·æ–°å®æ—¶æ•°æ®
                if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                    e.preventDefault();
                    if (currentAccount) {
                        refreshLiveData();
                    }
                }
                // Ctrl+Shift+R: åˆ·æ–°æ‰€æœ‰æ•°æ®
                if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                    e.preventDefault();
                    if (currentAccount) {
                        refreshAllData();
                    }
                }
            });

            // äº‹ä»¶å§”æ‰˜å¤„ç†å™¨å·²ç»å¤„ç†äº†æ‰€æœ‰æŒ‰é’®ç‚¹å‡»äº‹ä»¶ï¼Œä¸éœ€è¦é¢å¤–çš„äº‹ä»¶ç›‘å¬å™¨
            setTimeout(() => {

                // ç»Ÿä¸€çš„äº‹ä»¶å§”æ‰˜å¤„ç†å™¨
                document.addEventListener('click', function(e) {
                    const target = e.target;
                    const action = target.getAttribute('data-action');

                    if (!action) return;

                    console.log('ğŸ¯ æ£€æµ‹åˆ°æŒ‰é’®ç‚¹å‡»:', action);

                    try {
                        switch (action) {
                            case 'edit':
                                const recordId = target.getAttribute('data-record-id');
                                editRecord(parseInt(recordId));
                                break;

                            case 'delete':
                                const deleteRecordId = target.getAttribute('data-record-id');
                                deleteRecord(parseInt(deleteRecordId));
                                break;

                            case 'add-position':
                                const instrumentName = target.getAttribute('data-instrument');
                                addPositionToDatabase(instrumentName);
                                break;

                            case 'add-order':
                                const orderId = target.getAttribute('data-order-id');
                                const orderInstrument = target.getAttribute('data-instrument');
                                addOrderToDatabase(orderId, orderInstrument);
                                break;

                            case 'refresh-all':
                                refreshAllData();
                                break;

                            case 'refresh-live':
                                refreshLiveData();
                                break;

                            case 'close-modal':
                                closeModal();
                                break;

                            case 'close-quick-add':
                                closeQuickAddModal();
                                break;

                            case 'close-edit':
                                closeEditModal();
                                break;

                            case 'load-data':
                                loadData();
                                break;

                            case 'check-record':
                                const checkRecordId = target.getAttribute('data-record-id');
                                checkRecord(parseInt(checkRecordId));
                                break;

                            default:
                                console.log('âš ï¸ æœªçŸ¥çš„æ“ä½œ:', action);
                        }
                    } catch (error) {
                        console.error('âŒ æ‰§è¡Œæ“ä½œå¤±è´¥:', error);
                        alert('æ“ä½œå¤±è´¥: ' + error.message);
                    }
                });


            }, 1000);
        });





        // åŠ è½½è´¦æˆ·åˆ—è¡¨
        async function loadAccounts() {
            try {
                const response = await httpClient.get('/api/status');
                const data = response.data;

                // ä»APIå“åº”ä¸­æå–è´¦æˆ·åˆ—è¡¨
                if (data.accounts && Array.isArray(data.accounts)) {
                    availableAccounts = data.accounts.map(acc => acc.name || acc);
                    console.log(`ğŸ“‹ ä»APIè·å–åˆ° ${availableAccounts.length} ä¸ªè´¦æˆ·:`, availableAccounts);
                } else {
                    // å¦‚æœAPIæ²¡æœ‰è¿”å›è´¦æˆ·åˆ—è¡¨ï¼Œå°è¯•ä»å…¶ä»–å­—æ®µè·å–
                    console.warn('APIæœªè¿”å›accountså­—æ®µï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ');
                    availableAccounts = []; // ç©ºæ•°ç»„ï¼Œé¿å…ç¡¬ç¼–ç 
                }

                const select = document.getElementById('accountSelect');
                select.innerHTML = '<option value="">è¯·é€‰æ‹©è´¦æˆ·...</option>';

                if (availableAccounts.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'âš ï¸ æœªæ‰¾åˆ°å¯ç”¨è´¦æˆ·';
                    option.disabled = true;
                    select.appendChild(option);
                    showError('æœªæ‰¾åˆ°å¯ç”¨è´¦æˆ·ï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é…ç½®');
                } else {
                    availableAccounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account;
                        option.textContent = account;
                        select.appendChild(option);
                    });
                }

                select.addEventListener('change', function() {
                    if (this.value) {
                        selectAccount(this.value);
                        // æ›´æ–°URLå‚æ•°
                        const url = new URL(window.location);
                        url.searchParams.set('account', this.value);
                        window.history.pushState({}, '', url);
                    }
                });

            } catch (error) {
                showError('åŠ è½½è´¦æˆ·åˆ—è¡¨å¤±è´¥: ' + error.message);
            } finally {
                // å¦‚æœæ²¡æœ‰é€‰æ‹©è´¦æˆ·ï¼Œéšè—åŠ è½½çŠ¶æ€
                if (!currentAccount) {
                    hideLoading();
                }
            }
        }

        // é€‰æ‹©è´¦æˆ·
        function selectAccount(accountId) {
            // æ£€æŸ¥è´¦æˆ·æ˜¯å¦å­˜åœ¨
            if (!availableAccounts.includes(accountId)) {
                showError(`è´¦æˆ· "${accountId}" ä¸å­˜åœ¨ã€‚å¯ç”¨è´¦æˆ·: ${availableAccounts.join(', ')}`);
                // æ¸…ç©ºURLå‚æ•°
                const url = new URL(window.location);
                url.searchParams.delete('account');
                window.history.replaceState({}, '', url);
                // é‡ç½®é€‰æ‹©æ¡†
                document.getElementById('accountSelect').value = '';
                return;
            }

            currentAccount = accountId;
            loadData();
        }

        // åŠ è½½æ•°æ®
        async function loadData() {
            if (!currentAccount) {
                showError('è¯·å…ˆé€‰æ‹©è´¦æˆ·');
                return;
            }

            showLoading();
            
            try {
                // å¹¶è¡ŒåŠ è½½Deltaè®°å½•å’Œå®æ—¶æ•°æ®
                const [deltaResponse, liveResponse] = await Promise.all([
                    httpClient.get(`/api/delta/${currentAccount}`),
                    httpClient.get(`/api/delta/${currentAccount}/live-data`)
                ]);

                const deltaData = deltaResponse.data;
                const liveData = liveResponse.data;

                if (!deltaData.success) {
                    throw new Error(deltaData.message);
                }
                
                if (!liveData.success) {
                    throw new Error(liveData.message);
                }

                // æ›´æ–°æ•°æ®
                deltaRecords = deltaData.records || [];
                livePositions = liveData.data.positions || [];
                liveOrders = liveData.data.openOrders || [];

                // éªŒè¯è®°å½•æœ‰æ•ˆæ€§
                validateRecords();

                // æ›´æ–°ç•Œé¢
                updateStats(deltaData.summary);
                updatePositionRecordsTable();
                updateOrderRecordsTable();
                updatePositionsTable();
                updateOrdersTable();
                
                hideLoading();
                showSuccess('æ•°æ®åŠ è½½æˆåŠŸ');

            } catch (error) {
                hideLoading();
                showError('åŠ è½½æ•°æ®å¤±è´¥: ' + error.message);
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats(summary) {
            // è®¡ç®—è¯¦ç»†ç»Ÿè®¡
            const positionRecords = validatedRecords.filter(record => record.record_type === 'position');
            const orderRecords = deltaRecords.filter(record => record.record_type === 'order');

            // æ›´æ–°ä¸»è¦æ•°å€¼ (åªæœ‰ä»“ä½æœ‰Deltaå€¼)
            document.getElementById('totalDelta').textContent = (summary.position_delta || 0).toFixed(4);
            document.getElementById('positionDelta').textContent = (summary.position_delta || 0).toFixed(4);
            document.getElementById('orderCount').textContent = orderRecords.length;
            document.getElementById('recordCount').textContent = summary.record_count || 0;

            // æ›´æ–°å­æ ‡é¢˜
            document.getElementById('positionCount').textContent = `${positionRecords.length}ä¸ªä»“ä½`;
            document.getElementById('recordBreakdown').textContent = `ä»“ä½: ${positionRecords.length} | è®¢å•: ${orderRecords.length}`;

            // è®¾ç½®é¢œè‰² (åªæœ‰ä»“ä½Deltaéœ€è¦é¢œè‰²)
            const totalElement = document.getElementById('totalDelta');
            const positionElement = document.getElementById('positionDelta');

            const positionDelta = summary.position_delta || 0;

            totalElement.className = positionDelta >= 0 ? 'value delta-positive' : 'value delta-negative';
            positionElement.className = positionDelta >= 0 ? 'value delta-positive' : 'value delta-negative';
        }

        // æ›´æ–°ä»“ä½è®°å½•è¡¨æ ¼
        function updatePositionRecordsTable() {
            // å¦‚æœvalidatedRecordsä¸ºç©ºï¼Œä½¿ç”¨deltaRecordsä½œä¸ºåå¤‡
            const recordsToUse = validatedRecords.length > 0 ? validatedRecords : deltaRecords;

            const tbody = document.querySelector('#positionRecordsTable tbody');
            tbody.innerHTML = '';

            const positionRecords = recordsToUse.filter(record => record.record_type === 'position');

            positionRecords.forEach(record => {
                const row = document.createElement('tr');

                // æ ¹æ®éªŒè¯çŠ¶æ€è®¾ç½®è¡Œæ ·å¼
                if (record.is_valid === false) {
                    row.classList.add('invalid-record');
                }

                // çŠ¶æ€æ˜¾ç¤º
                let statusHtml = '';
                if (record.is_valid === true) {
                    statusHtml = '<span class="status-valid">âœ… æœ‰æ•ˆ</span>';
                } else if (record.is_valid === false) {
                    statusHtml = `<span class="status-invalid" title="${record.validation_message}">âŒ æ— æ•ˆ</span>`;
                } else {
                    statusHtml = '<span class="status-unknown">â“ æœªéªŒè¯</span>';
                }

                // è®¡ç®—Deltaå¹³å‡å€¼ï¼šä»å®æ—¶ä»“ä½æ•°æ®ä¸­æŸ¥æ‰¾å¯¹åº”çš„ä»“ä½
                let deltaAverageHtml = '-';
                const livePosition = livePositions.find(pos => pos.instrument_name === record.instrument_name);
                if (livePosition) {
                    const size = livePosition.size || livePosition.amount || 0;
                    const delta = livePosition.delta || 0;

                    if (size !== 0) {
                        const deltaAverage = delta / Math.abs(size);
                        const deltaClass = deltaAverage >= 0 ? 'delta-positive' : 'delta-negative';
                        deltaAverageHtml = `<span class="${deltaClass}">${deltaAverage.toFixed(4)}</span>`;
                    }
                }

                row.innerHTML = `
                    <td>${statusHtml}</td>
                    <td>${record.instrument_name}</td>
                    <td class="${record.target_delta >= 0 ? 'delta-positive' : 'delta-negative'}">${record.target_delta.toFixed(4)}</td>
                    <td class="${(record.move_position_delta || 0) >= 0 ? 'delta-positive' : 'delta-negative'}">${(record.move_position_delta || 0).toFixed(4)}</td>
                    <td>${record.min_expire_days || '-'}</td>
                    <td>${deltaAverageHtml}</td>
                    <td>${record.tv_id || '-'}</td>
                    <td>${new Date(record.created_at).toLocaleString()}</td>
                    <td>${new Date(record.updated_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-warning" data-action="edit" data-record-id="${record.id}">ç¼–è¾‘</button>
                        <button class="btn btn-danger" data-action="delete" data-record-id="${record.id}">åˆ é™¤</button>
                        ${record.is_valid === false ? '<button class="btn btn-info" data-action="check-record" data-record-id="' + record.id + '">æ£€æŸ¥</button>' : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (positionRecords.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="9" style="text-align: center; color: #7f8c8d;">æš‚æ— ä»“ä½è®°å½•</td>';
                tbody.appendChild(row);
            }
        }

        // æ›´æ–°è®¢å•è®°å½•è¡¨æ ¼
        function updateOrderRecordsTable() {
            // å¦‚æœvalidatedRecordsä¸ºç©ºï¼Œä½¿ç”¨deltaRecordsä½œä¸ºåå¤‡
            const recordsToUse = validatedRecords.length > 0 ? validatedRecords : deltaRecords;

            const tbody = document.querySelector('#orderRecordsTable tbody');
            tbody.innerHTML = '';

            const orderRecords = recordsToUse.filter(record => record.record_type === 'order');

            orderRecords.forEach(record => {
                const row = document.createElement('tr');

                // æ ¹æ®éªŒè¯çŠ¶æ€è®¾ç½®è¡Œæ ·å¼
                if (record.is_valid === false) {
                    row.classList.add('invalid-record');
                }

                // çŠ¶æ€æ˜¾ç¤º
                let statusHtml = '';
                if (record.is_valid === true) {
                    statusHtml = '<span class="status-valid">âœ… æœ‰æ•ˆ</span>';
                } else if (record.is_valid === false) {
                    statusHtml = `<span class="status-invalid" title="${record.validation_message}">âŒ æ— æ•ˆ</span>`;
                } else {
                    statusHtml = '<span class="status-unknown">â“ æœªéªŒè¯</span>';
                }

                row.innerHTML = `
                    <td>${statusHtml}</td>
                    <td>${record.order_id || '-'}</td>
                    <td>${record.instrument_name}</td>
                    <td class="${record.target_delta >= 0 ? 'delta-positive' : 'delta-negative'}">${record.target_delta.toFixed(4)}</td>
                    <td class="${(record.move_position_delta || 0) >= 0 ? 'delta-positive' : 'delta-negative'}">${(record.move_position_delta || 0).toFixed(4)}</td>
                    <td>${record.min_expire_days || '-'}</td>
                    <td>${record.tv_id || '-'}</td>
                    <td>${new Date(record.created_at).toLocaleString()}</td>
                    <td>${new Date(record.updated_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-warning" data-action="edit" data-record-id="${record.id}">ç¼–è¾‘</button>
                        <button class="btn btn-danger" data-action="delete" data-record-id="${record.id}">åˆ é™¤</button>
                        ${record.is_valid === false ? '<button class="btn btn-info" data-action="check-record" data-record-id="' + record.id + '">æ£€æŸ¥</button>' : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (orderRecords.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="9" style="text-align: center; color: #7f8c8d;">æš‚æ— è®¢å•è®°å½•</td>';
                tbody.appendChild(row);
            }
        }

        // æ›´æ–°ä»“ä½è¡¨æ ¼
        function updatePositionsTable() {
            const tbody = document.querySelector('#positionsTable tbody');
            tbody.innerHTML = '';

            // è¿‡æ»¤å‡ºæœªè®°å½•åœ¨æ•°æ®åº“ä¸­çš„ä»“ä½
            const unrecordedPositions = livePositions.filter(position => {
                return !deltaRecords.some(record =>
                    record.instrument_name === position.instrument_name &&
                    record.record_type === 'position'
                );
            });

            unrecordedPositions.forEach(position => {
                const row = document.createElement('tr');

                // å¤„ç†çœŸå®Deribitæ•°æ®æ ¼å¼
                const size = position.size || position.amount || 0;
                const avgPrice = position.average_price || position.average_price_usd || 0;
                const markPrice = position.mark_price || 0;
                const delta = position.delta || 0;

                // è®¡ç®—Deltaå¹³å‡å€¼ï¼šä»“ä½çš„delta / ä»“ä½æ•°é‡
                let deltaAverage = 0;
                if (size !== 0) {
                    deltaAverage = delta / Math.abs(size);
                }

                row.innerHTML = `
                    <td>${position.instrument_name}</td>
                    <td>${size}</td>
                    <td>${position.direction}</td>
                    <td>${typeof avgPrice === 'number' ? avgPrice.toFixed(5) : avgPrice}</td>
                    <td>${typeof markPrice === 'number' ? markPrice.toFixed(5) : markPrice}</td>
                    <td class="${delta >= 0 ? 'delta-positive' : 'delta-negative'}">${typeof delta === 'number' ? delta.toFixed(4) : delta}</td>
                    <td class="${deltaAverage >= 0 ? 'delta-positive' : 'delta-negative'}">${deltaAverage.toFixed(4)}</td>
                    <td>
                        <button class="btn btn-success" data-action="add-position" data-instrument="${position.instrument_name}">
                            â• æ·»åŠ åˆ°æ•°æ®åº“
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (unrecordedPositions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" style="text-align: center; color: #7f8c8d;">æ‰€æœ‰ä»“ä½éƒ½å·²è®°å½•åœ¨æ•°æ®åº“ä¸­</td>';
                tbody.appendChild(row);
            }
        }

        // æ›´æ–°è®¢å•è¡¨æ ¼
        function updateOrdersTable() {
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = '';

            // è¿‡æ»¤å‡ºæœªè®°å½•åœ¨æ•°æ®åº“ä¸­çš„è®¢å•
            const unrecordedOrders = liveOrders.filter(order => {
                return !deltaRecords.some(record =>
                    record.order_id === order.order_id
                );
            });

            unrecordedOrders.forEach(order => {
                const row = document.createElement('tr');

                // å¤„ç†çœŸå®Deribitè®¢å•æ•°æ®æ ¼å¼
                const orderId = order.order_id || order.id || 'N/A';
                const amount = order.amount || order.size || 0;
                const price = order.price || order.limit_price || 0;
                const orderType = order.order_type || order.type || 'unknown';

                row.innerHTML = `
                    <td>${orderId}</td>
                    <td>${order.instrument_name}</td>
                    <td>${order.direction}</td>
                    <td>${amount}</td>
                    <td>${typeof price === 'number' ? price.toFixed(5) : price}</td>
                    <td>${orderType}</td>
                    <td>
                        <button class="btn btn-success" data-action="add-order" data-order-id="${orderId}" data-instrument="${order.instrument_name}">
                            â• æ·»åŠ åˆ°æ•°æ®åº“
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (unrecordedOrders.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" style="text-align: center; color: #7f8c8d;">æ‰€æœ‰è®¢å•éƒ½å·²è®°å½•åœ¨æ•°æ®åº“ä¸­</td>';
                tbody.appendChild(row);
            }
        }



        // ç¼–è¾‘è®°å½•
        function editRecord(recordId) {
            const record = deltaRecords.find(r => r.id === recordId);
            if (!record) return;

            editingRecordId = recordId;
            document.getElementById('modalTitle').textContent = 'ç¼–è¾‘Deltaè®°å½•';
            document.getElementById('instrumentName').value = record.instrument_name;
            document.getElementById('deltaValue').value = record.delta;
            document.getElementById('tvId').value = record.tv_id;
            document.getElementById('recordType').value = record.record_type;
            document.getElementById('orderId').value = record.order_id || '';
            document.getElementById('recordModal').style.display = 'block';
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('recordModal').style.display = 'none';
            editingRecordId = null;
        }

        // ä¿å­˜è®°å½•
        document.getElementById('recordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                instrument_name: document.getElementById('instrumentName').value,
                delta: parseFloat(document.getElementById('deltaValue').value),
                tv_id: parseInt(document.getElementById('tvId').value),
                record_type: document.getElementById('recordType').value,
                order_id: document.getElementById('orderId').value || null
            };

            try {
                let response;
                if (editingRecordId) {
                    // æ›´æ–°è®°å½•
                    response = await httpClient.put(`/api/delta/${currentAccount}/${editingRecordId}`, formData);
                } else {
                    // åˆ›å»ºè®°å½•
                    response = await httpClient.post(`/api/delta/${currentAccount}`, formData);
                }

                const result = response.data;

                if (!result.success) {
                    throw new Error(result.message);
                }

                closeModal();
                showSuccess(editingRecordId ? 'è®°å½•æ›´æ–°æˆåŠŸ' : 'è®°å½•åˆ›å»ºæˆåŠŸ');
                loadData();

            } catch (error) {
                showError('ä¿å­˜å¤±è´¥: ' + error.message);
            }
        });

        // åˆ é™¤è®°å½• - ç¡®ä¿åœ¨å…¨å±€ä½œç”¨åŸŸ
        window.deleteRecord = async function(recordId) {
            // è·å–è¦åˆ é™¤çš„è®°å½•ä¿¡æ¯
            const record = validatedRecords.find(r => r.id === recordId);
            if (!record) {
                showError('è®°å½•ä¸å­˜åœ¨');
                return;
            }

            // æ˜¾ç¤ºè¯¦ç»†çš„ç¡®è®¤å¯¹è¯æ¡†
            const confirmMessage = `ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ\n\n` +
                `åˆçº¦: ${record.instrument_name}\n` +
                `ç›®æ ‡Delta: ${record.target_delta}\n` +
                `ç§»ä»“Delta: ${record.move_position_delta || 0}\n` +
                `ç±»å‹: ${record.record_type === 'position' ? 'ä»“ä½' : 'è®¢å•'}\n` +
                `TV_ID: ${record.tv_id}\n` +
                `åˆ›å»ºæ—¶é—´: ${new Date(record.created_at).toLocaleString()}`;

            if (!confirm(confirmMessage)) return;

            try {
                console.log('ğŸ—‘ï¸ åˆ é™¤è®°å½•:', recordId);

                const response = await fetch(`/api/delta/${currentAccount}/${recordId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                showSuccess(`è®°å½•åˆ é™¤æˆåŠŸ (${record.instrument_name})`);
                loadData();

            } catch (error) {
                console.error('âŒ åˆ é™¤è®°å½•å¤±è´¥:', error);
                showError('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        };

        // æ£€æŸ¥è®°å½• - ç¡®ä¿åœ¨å…¨å±€ä½œç”¨åŸŸ
        window.checkRecord = function(recordId) {
            const record = validatedRecords.find(r => r.id === recordId);
            if (!record) {
                showError('è®°å½•ä¸å­˜åœ¨');
                return;
            }

            let message = `è®°å½•æ£€æŸ¥ç»“æœ:\n\n`;
            message += `åˆçº¦: ${record.instrument_name}\n`;
            message += `ç±»å‹: ${record.record_type === 'position' ? 'ä»“ä½' : 'è®¢å•'}\n`;
            message += `ç›®æ ‡Delta: ${record.target_delta}\n`;
            message += `ç§»ä»“Delta: ${record.move_position_delta || 0}\n`;
            message += `TV_ID: ${record.tv_id || 'æ— '}\n`;
            message += `åˆ›å»ºæ—¶é—´: ${new Date(record.created_at).toLocaleString()}\n\n`;

            if (record.is_valid === false) {
                message += `âŒ çŠ¶æ€: æ— æ•ˆ\n`;
                message += `åŸå› : ${record.validation_message}\n\n`;
                message += `å»ºè®®æ“ä½œ:\n`;
                message += `1. æ£€æŸ¥Deribitè´¦æˆ·ä¸­æ˜¯å¦å­˜åœ¨å¯¹åº”çš„${record.record_type === 'position' ? 'ä»“ä½' : 'è®¢å•'}\n`;
                message += `2. å¦‚æœ${record.record_type === 'position' ? 'ä»“ä½å·²å¹³ä»“' : 'è®¢å•å·²å–æ¶ˆ'}ï¼Œå¯ä»¥åˆ é™¤æ­¤è®°å½•\n`;
                message += `3. å¦‚æœåˆçº¦åç§°æœ‰è¯¯ï¼Œå¯ä»¥ç¼–è¾‘ä¿®æ­£\n`;
                message += `4. ç‚¹å‡»"åˆ·æ–°"æŒ‰é’®é‡æ–°éªŒè¯æ•°æ®`;
            } else if (record.is_valid === true) {
                message += `âœ… çŠ¶æ€: æœ‰æ•ˆ\n`;
                message += `æ­¤è®°å½•å¯¹åº”çš„${record.record_type === 'position' ? 'ä»“ä½' : 'è®¢å•'}åœ¨Deribitè´¦æˆ·ä¸­å­˜åœ¨`;
            } else {
                message += `â“ çŠ¶æ€: æœªéªŒè¯\n`;
                message += `æ— æ³•éªŒè¯æ­¤è®°å½•çš„æœ‰æ•ˆæ€§ï¼Œå¯èƒ½æ˜¯ç½‘ç»œé—®é¢˜æˆ–APIé™åˆ¶`;
            }

            alert(message);
        };

        // å‰ç«¯éªŒè¯è®°å½•æœ‰æ•ˆæ€§
        function validateRecords() {
            validatedRecords = deltaRecords.map(record => {
                let isValid = false;
                let validationMessage = '';

                if (record.record_type === 'position') {
                    // æ£€æŸ¥ä»“ä½æ˜¯å¦å­˜åœ¨
                    const position = livePositions.find(p => p.instrument_name === record.instrument_name);
                    if (position) {
                        isValid = true;
                    } else {
                        validationMessage = 'ä»“ä½ä¸å­˜åœ¨äºè´¦æˆ·ä¸­';
                    }
                } else if (record.record_type === 'order') {
                    // æ£€æŸ¥è®¢å•æ˜¯å¦å­˜åœ¨
                    const order = liveOrders.find(o =>
                        o.instrument_name === record.instrument_name &&
                        (o.order_id === record.order_id || o.id === record.order_id)
                    );
                    if (order) {
                        isValid = true;
                    } else {
                        validationMessage = 'è®¢å•ä¸å­˜åœ¨äºè´¦æˆ·ä¸­';
                    }
                }

                return {
                    ...record,
                    is_valid: isValid,
                    validation_message: validationMessage
                };
            });

            const validCount = validatedRecords.filter(r => r.is_valid).length;
            const invalidCount = validatedRecords.filter(r => !r.is_valid).length;
        }

        // æ·»åŠ ä»“ä½åˆ°æ•°æ®åº“ - ç¡®ä¿åœ¨å…¨å±€ä½œç”¨åŸŸ
        window.addPositionToDatabase = function(instrumentName) {
            try {
                showQuickAddModal(instrumentName, 'position');
            } catch (error) {
                console.error('âŒ addPositionToDatabase é”™è¯¯:', error);
                alert('æ·»åŠ ä»“ä½å¤±è´¥: ' + error.message);
            }
        };

        // æ·»åŠ è®¢å•åˆ°æ•°æ®åº“ - ç¡®ä¿åœ¨å…¨å±€ä½œç”¨åŸŸ
        window.addOrderToDatabase = function(orderId, instrumentName) {
            console.log('ğŸ¯ addOrderToDatabase è¢«è°ƒç”¨:', orderId, instrumentName);
            try {
                showQuickAddModal(instrumentName, 'order', orderId);
            } catch (error) {
                console.error('âŒ addOrderToDatabase é”™è¯¯:', error);
                alert('æ·»åŠ è®¢å•å¤±è´¥: ' + error.message);
            }
        };



        // åˆ·æ–°å®æ—¶æ•°æ®
        async function refreshLiveData() {

            if (!currentAccount) {
                showError('è¯·å…ˆé€‰æ‹©è´¦æˆ·');
                return;
            }

            const refreshBtn = document.getElementById('refreshBtn');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°ä¸­...';
            refreshBtn.style.opacity = '0.6';

            try {
                console.log(`ğŸ”„ åˆ·æ–°æ‰€æœ‰å“ç§æœŸæƒå®æ—¶æ•°æ®...`);

                const response = await httpClient.get(`/api/delta/${currentAccount}/live-data`);
                const data = response.data;

                if (!data.success) {
                    throw new Error(data.message);
                }

                // æ›´æ–°å…¨å±€å˜é‡
                livePositions = data.data.positions || [];
                liveOrders = data.data.openOrders || [];

                // æ›´æ–°è¡¨æ ¼
                updatePositionsTable();
                updateOrdersTable();

                // æ˜¾ç¤ºè¯¦ç»†çš„åˆ·æ–°ç»“æœ
                const positionCount = livePositions.length;
                const orderCount = liveOrders.length;
                const mockMode = data.mockMode ? ' (Mockæ¨¡å¼)' : '';

                showSuccess(`æ‰€æœ‰å“ç§æœŸæƒå®æ—¶æ•°æ®åˆ·æ–°æˆåŠŸ${mockMode} - ä»“ä½: ${positionCount}ä¸ª, è®¢å•: ${orderCount}ä¸ª`);



            } catch (error) {
                console.error('âŒ åˆ·æ–°å¤±è´¥:', error);
                showError(`åˆ·æ–°æ•°æ®å¤±è´¥: ${error.message}`);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'ğŸ”„ åˆ·æ–°';
                refreshBtn.style.opacity = '1';
            }
        }



        // åˆ·æ–°æ‰€æœ‰æ•°æ® (åŒ…æ‹¬æ•°æ®åº“è®°å½•)
        async function refreshAllData() {

            if (!currentAccount) {
                showError('è¯·å…ˆé€‰æ‹©è´¦æˆ·');
                return;
            }

            const refreshAllBtn = document.getElementById('refreshAllBtn');

            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            refreshAllBtn.disabled = true;
            refreshAllBtn.innerHTML = 'ğŸ”„ åˆ·æ–°ä¸­...';
            refreshAllBtn.style.opacity = '0.6';

            try {
                console.log('ğŸ”„ åˆ·æ–°æ‰€æœ‰æ•°æ®...');

                // é‡æ–°åŠ è½½æ‰€æœ‰æ•°æ®
                await loadData();

                showSuccess('æ‰€æœ‰æ•°æ®åˆ·æ–°æˆåŠŸ');

            } catch (error) {
                console.error('âŒ åˆ·æ–°æ‰€æœ‰æ•°æ®å¤±è´¥:', error);
                showError('åˆ·æ–°æ‰€æœ‰æ•°æ®å¤±è´¥: ' + error.message);
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                refreshAllBtn.disabled = false;
                refreshAllBtn.innerHTML = 'ğŸ”„ åˆ·æ–°æ‰€æœ‰';
                refreshAllBtn.style.opacity = '1';
            }
        }

        // å·¥å…·å‡½æ•°
        function showLoading(message = 'ğŸ”„ æ­£åœ¨åŠ è½½æ•°æ®...') {
            const loadingElement = document.getElementById('loadingMessage');
            loadingElement.innerHTML = `<h3>${message}</h3>`;
            loadingElement.style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            setTimeout(() => {
                document.getElementById('errorMessage').style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            setTimeout(() => {
                document.getElementById('successMessage').style.display = 'none';
            }, 3000);
        }

        // æ˜¾ç¤ºå¿«é€Ÿæ·»åŠ æ¨¡æ€æ¡† - ç¡®ä¿åœ¨å…¨å±€ä½œç”¨åŸŸ
        window.showQuickAddModal = function(instrumentName, recordType, orderId = null) {
            console.log('ğŸ”„ showQuickAddModal è¢«è°ƒç”¨:', instrumentName, recordType, orderId);

            try {
                document.getElementById('quickInstrumentName').value = instrumentName;
                document.getElementById('quickTargetDeltaValue').value = '';
                document.getElementById('quickMovePositionDeltaValue').value = '';
                document.getElementById('quickTvId').value = '';

                const quickTargetDeltaGroup = document.getElementById('quickTargetDeltaGroup');
                const quickMovePositionDeltaGroup = document.getElementById('quickMovePositionDeltaGroup');
                const quickOrderIdGroup = document.getElementById('quickOrderIdGroup');
                const quickTargetDeltaInput = document.getElementById('quickTargetDeltaValue');
                const quickMovePositionDeltaInput = document.getElementById('quickMovePositionDeltaValue');

                if (recordType === 'order' && orderId) {
                    // è®¢å•è®°å½•ï¼šæ˜¾ç¤ºè®¢å•IDå’Œç›®æ ‡Deltaå­—æ®µå’Œç§»ä»“Deltaå­—æ®µ
                    document.getElementById('quickOrderId').value = orderId;
                    quickOrderIdGroup.style.display = 'block';
                    quickTargetDeltaGroup.style.display = 'block';
                    quickMovePositionDeltaGroup.style.display = 'block';
                    quickTargetDeltaInput.value = ''; // è®¢å•ç›®æ ‡Deltaä¹Ÿéœ€è¦ç”¨æˆ·è¾“å…¥
                    quickMovePositionDeltaInput.value = ''; // è®¢å•ç§»ä»“Deltaä¹Ÿéœ€è¦ç”¨æˆ·è¾“å…¥
                    quickTargetDeltaInput.required = true;
                    quickMovePositionDeltaInput.required = true;

                    document.getElementById('quickAddTitle').textContent = 'æ·»åŠ è®¢å•åˆ°æ•°æ®åº“';
                } else {
                    // ä»“ä½è®°å½•ï¼šéšè—è®¢å•IDï¼Œæ˜¾ç¤ºç›®æ ‡Deltaå­—æ®µå’Œç§»ä»“Deltaå­—æ®µ
                    quickOrderIdGroup.style.display = 'none';
                    quickTargetDeltaGroup.style.display = 'block';
                    quickMovePositionDeltaGroup.style.display = 'block';
                    quickTargetDeltaInput.required = true;
                    quickMovePositionDeltaInput.required = true;

                    document.getElementById('quickAddTitle').textContent = 'æ·»åŠ ä»“ä½åˆ°æ•°æ®åº“';
                }

                // å­˜å‚¨å½“å‰æ“ä½œä¿¡æ¯
                window.currentQuickAdd = {
                    instrumentName: instrumentName,
                    recordType: recordType,
                    orderId: orderId
                };


                document.getElementById('quickAddModal').style.display = 'block';

            } catch (error) {
                console.error('âŒ showQuickAddModal é”™è¯¯:', error);
                alert('æ˜¾ç¤ºæ·»åŠ ç•Œé¢å¤±è´¥: ' + error.message);
            }
        };

        // å…³é—­å¿«é€Ÿæ·»åŠ æ¨¡æ€æ¡†
        function closeQuickAddModal() {
            document.getElementById('quickAddModal').style.display = 'none';
            window.currentQuickAdd = null;
        }

        // å¤„ç†å¿«é€Ÿæ·»åŠ è¡¨å•æäº¤
        document.getElementById('quickAddForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!window.currentQuickAdd) return;

            const targetDeltaInput = document.getElementById('quickTargetDeltaValue').value;
            const movePositionDeltaInput = document.getElementById('quickMovePositionDeltaValue').value;
            const tvIdInput = document.getElementById('quickTvId').value;

            // éªŒè¯æ‰€æœ‰è®°å½•éƒ½å¿…é¡»æœ‰target_deltaå€¼
            if (!targetDeltaInput.trim()) {
                showError('å¿…é¡»è¾“å…¥ç›®æ ‡Deltaå€¼');
                return;
            }

            // éªŒè¯æ‰€æœ‰è®°å½•éƒ½å¿…é¡»æœ‰move_position_deltaå€¼
            if (!movePositionDeltaInput.trim()) {
                showError('å¿…é¡»è¾“å…¥ç§»ä»“Deltaå€¼');
                return;
            }

            const targetDeltaValue = parseFloat(targetDeltaInput);
            if (isNaN(targetDeltaValue) || targetDeltaValue < -1 || targetDeltaValue > 1) {
                showError('ç›®æ ‡Deltaå€¼å¿…é¡»åœ¨-1åˆ°1ä¹‹é—´');
                return;
            }

            const movePositionDeltaValue = parseFloat(movePositionDeltaInput);
            if (isNaN(movePositionDeltaValue) || movePositionDeltaValue < -1 || movePositionDeltaValue > 1) {
                showError('ç§»ä»“Deltaå€¼å¿…é¡»åœ¨-1åˆ°1ä¹‹é—´');
                return;
            }

            const minExpireDaysInput = document.getElementById('quickMinExpireDays').value.trim();
            let minExpireDaysValue = null;

            if (minExpireDaysInput) {
                minExpireDaysValue = parseInt(minExpireDaysInput);
                if (isNaN(minExpireDaysValue) || minExpireDaysValue <= 0) {
                    showError('æœ€å°åˆ°æœŸå¤©æ•°å¿…é¡»æ˜¯å¤§äº0çš„æ•´æ•°');
                    return;
                }
            }

            const tvId = tvIdInput.trim() ? parseInt(tvIdInput) : null;

            const formData = {
                instrument_name: window.currentQuickAdd.instrumentName,
                target_delta: targetDeltaValue,
                move_position_delta: movePositionDeltaValue,
                min_expire_days: minExpireDaysValue,
                tv_id: tvId,
                record_type: window.currentQuickAdd.recordType
            };

            if (window.currentQuickAdd.orderId) {
                formData.order_id = window.currentQuickAdd.orderId;
            }

            try {
                const response = await httpClient.post(`/api/delta/${currentAccount}`, formData);

                const result = response.data;

                if (!result.success) {
                    throw new Error(result.message);
                }

                const recordTypeText = window.currentQuickAdd.recordType === 'position' ? 'ä»“ä½' : 'è®¢å•';
                closeQuickAddModal();
                showSuccess(`${recordTypeText}å·²æ·»åŠ åˆ°æ•°æ®åº“ (ç›®æ ‡Delta: ${targetDeltaValue}, ç§»ä»“Delta: ${movePositionDeltaValue}, TV_ID: ${tvId})`);
                loadData();

            } catch (error) {
                showError('æ·»åŠ å¤±è´¥: ' + error.message);
            }
        });

        // ç¼–è¾‘è®°å½•
        function editRecord(recordId) {
            const record = validatedRecords.find(r => r.id === recordId);
            if (!record) {
                showError('è®°å½•ä¸å­˜åœ¨');
                return;
            }

            // å¡«å……ç¼–è¾‘è¡¨å•
            document.getElementById('editInstrumentName').value = record.instrument_name;
            document.getElementById('editTargetDeltaValue').value = record.target_delta;
            document.getElementById('editMovePositionDeltaValue').value = record.move_position_delta || 0;
            document.getElementById('editMinExpireDays').value = record.min_expire_days || '';
            document.getElementById('editTvId').value = record.tv_id || '';

            // æ ¹æ®è®°å½•ç±»å‹æ˜¾ç¤º/éšè—å­—æ®µ
            const editTargetDeltaGroup = document.getElementById('editTargetDeltaGroup');
            const editMovePositionDeltaGroup = document.getElementById('editMovePositionDeltaGroup');
            const editOrderIdGroup = document.getElementById('editOrderIdGroup');

            if (record.record_type === 'order') {
                // è®¢å•è®°å½•ï¼šæ˜¾ç¤ºç›®æ ‡Deltaå­—æ®µã€ç§»ä»“Deltaå­—æ®µå’Œè®¢å•ID
                editTargetDeltaGroup.style.display = 'block';
                editMovePositionDeltaGroup.style.display = 'block';
                editOrderIdGroup.style.display = 'block';
                document.getElementById('editOrderId').value = record.order_id || '';
            } else {
                // ä»“ä½è®°å½•ï¼šæ˜¾ç¤ºç›®æ ‡Deltaå­—æ®µã€ç§»ä»“Deltaå­—æ®µï¼Œéšè—è®¢å•ID
                editTargetDeltaGroup.style.display = 'block';
                editMovePositionDeltaGroup.style.display = 'block';
                editOrderIdGroup.style.display = 'none';
            }

            // å­˜å‚¨å½“å‰ç¼–è¾‘çš„è®°å½•ID
            window.currentEditingRecord = record;

            // æ˜¾ç¤ºç¼–è¾‘æ¨¡æ€æ¡†
            document.getElementById('editModal').style.display = 'block';
        }

        // å…³é—­ç¼–è¾‘æ¨¡æ€æ¡†
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            window.currentEditingRecord = null;
        }

        // å¤„ç†ç¼–è¾‘è¡¨å•æäº¤
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!window.currentEditingRecord) return;

            const targetDeltaValue = parseFloat(document.getElementById('editTargetDeltaValue').value);
            const movePositionDeltaValue = parseFloat(document.getElementById('editMovePositionDeltaValue').value);
            const minExpireDaysInput = document.getElementById('editMinExpireDays').value.trim();
            const tvIdInput = document.getElementById('editTvId').value.trim();
            const tvId = tvIdInput ? parseInt(tvIdInput) : null;

            // éªŒè¯æœ€å°åˆ°æœŸå¤©æ•°
            let minExpireDaysValue = null;
            if (minExpireDaysInput) {
                minExpireDaysValue = parseInt(minExpireDaysInput);
                if (isNaN(minExpireDaysValue) || minExpireDaysValue <= 0) {
                    showError('æœ€å°åˆ°æœŸå¤©æ•°å¿…é¡»æ˜¯å¤§äº0çš„æ•´æ•°');
                    return;
                }
            }

            const updateData = {
                tv_id: tvId,
                target_delta: targetDeltaValue,  // ä»“ä½å’Œè®¢å•éƒ½å¯ä»¥æ›´æ–°ç›®æ ‡Delta
                move_position_delta: movePositionDeltaValue,  // ä»“ä½å’Œè®¢å•éƒ½å¯ä»¥æ›´æ–°ç§»ä»“Delta
                min_expire_days: minExpireDaysValue  // æœ€å°åˆ°æœŸå¤©æ•°
            };

            try {
                const response = await httpClient.put(`/api/delta/${currentAccount}/${window.currentEditingRecord.id}`, updateData);

                const result = response.data;

                if (!result.success) {
                    throw new Error(result.message);
                }

                closeEditModal();
                showSuccess('è®°å½•æ›´æ–°æˆåŠŸ');
                loadData();

            } catch (error) {
                showError('æ›´æ–°å¤±è´¥: ' + error.message);
            }
        });

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const recordModal = document.getElementById('recordModal');
            const quickAddModal = document.getElementById('quickAddModal');
            const editModal = document.getElementById('editModal');

            if (event.target === recordModal) {
                closeModal();
            } else if (event.target === quickAddModal) {
                closeQuickAddModal();
            } else if (event.target === editModal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>
