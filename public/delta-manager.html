<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DeltaÁÆ°ÁêÜÂô® - DeribitÊúüÊùÉ‰∫§Êòì</title>
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üìä</text></svg>">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .account-selector {
            margin: 20px 0;
        }

        .account-selector select {
            padding: 10px 15px;
            font-size: 16px;
            border: 2px solid #3498db;
            border-radius: 8px;
            background: white;
            color: #2c3e50;
            cursor: pointer;
        }

        .main-content {
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }

        .stat-card h3 {
            font-size: 0.9em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .stat-card .value {
            font-size: 1.8em;
            font-weight: bold;
        }

        .stat-subtitle {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
            font-style: italic;
        }

        .section {
            margin-bottom: 40px;
        }

        .section-title {
            font-size: 1.5em;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #3498db;
        }

        .table-container {
            background: #f8f9fa;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #2c3e50;
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background: #e3f2fd;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-warning {
            background: #f39c12;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: none;
        }

        .section-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
        }

        .section-title > div {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #currencySelect {
            border: 2px solid #3498db;
            border-radius: 5px;
            background: white;
            color: #2c3e50;
            font-size: 14px;
        }

        #currencySelect:focus {
            outline: none;
            border-color: #2980b9;
        }

        .form-group label span {
            color: #e74c3c;
            font-weight: bold;
        }

        .form-group input:required {
            border-left: 3px solid #e74c3c;
        }

        .form-group input:required:valid {
            border-left: 3px solid #27ae60;
        }

        /* Êï∞ÊçÆÈ™åËØÅÁä∂ÊÄÅÊ†∑Âºè */
        .status-valid {
            color: #27ae60;
            font-weight: bold;
        }

        .status-invalid {
            color: #e74c3c;
            font-weight: bold;
            cursor: help;
        }

        .status-unknown {
            color: #f39c12;
            font-weight: bold;
        }

        .invalid-record {
            background-color: #fdf2f2;
            border-left: 4px solid #e74c3c;
        }

        .invalid-record:hover {
            background-color: #fce4e4;
        }

        .btn-info {
            background: #3498db;
            color: white;
            font-size: 12px;
            padding: 5px 10px;
        }

        .btn-info:hover {
            background: #2980b9;
        }

        .delta-positive {
            color: #27ae60;
            font-weight: bold;
        }

        .delta-negative {
            color: #e74c3c;
            font-weight: bold;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 16px;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .refresh-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #3498db;
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            transform: scale(1.1);
            background: #2980b9;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 10px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- ÂºïÂÖ• axios Â∫ì - Â§ö‰∏™Â§áÁî® CDN -->
    <script>
        // Â∞ùËØïÂ§ö‰∏™ CDN Ê∫ê
        const cdnUrls = [
            'https://unpkg.com/axios@1.6.0/dist/axios.min.js',
            'https://cdn.bootcdn.net/ajax/libs/axios/1.6.0/axios.min.js',
            'https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.0/axios.min.js'
        ];

        let currentCdnIndex = 0;

        function loadAxios() {
            if (currentCdnIndex >= cdnUrls.length) {
                console.error('ÊâÄÊúâ axios CDN ÈÉΩÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî® fetch ‰Ωú‰∏∫Â§áÁî®ÊñπÊ°à');
                return;
            }

            const script = document.createElement('script');
            script.src = cdnUrls[currentCdnIndex];
            script.onload = function() {
                console.log(`axios Âä†ËΩΩÊàêÂäüÔºå‰ΩøÁî® CDN: ${cdnUrls[currentCdnIndex]}`);
            };
            script.onerror = function() {
                console.warn(`CDN Âä†ËΩΩÂ§±Ë¥•: ${cdnUrls[currentCdnIndex]}`);
                currentCdnIndex++;
                loadAxios();
            };
            document.head.appendChild(script);
        }

        loadAxios();
    </script>
    <div class="container">
        <div class="header">
            <h1>üéØ DeltaÁÆ°ÁêÜÂô®</h1>
            <p>DeribitÊúüÊùÉ‰ªì‰ΩçÂíåËÆ¢ÂçïDeltaÁÆ°ÁêÜ</p>
            
            <div class="account-selector">
                <label for="accountSelect" style="margin-right: 10px;">ÈÄâÊã©Ë¥¶Êà∑:</label>
                <select id="accountSelect">
                    <option value="">ËØ∑ÈÄâÊã©Ë¥¶Êà∑...</option>
                </select>
            </div>
        </div>

        <div class="main-content">
            <div id="loadingMessage" class="loading">
                <h3>üîÑ Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...</h3>
            </div>

            <div id="errorMessage" class="error" style="display: none;"></div>
            <div id="successMessage" class="success" style="display: none;"></div>

            <div id="mainContent" style="display: none;">
                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>ÊÄªDelta</h3>
                        <div class="value" id="totalDelta">0.00</div>
                    </div>
                    <div class="stat-card">
                        <h3>‰ªì‰ΩçDelta</h3>
                        <div class="value" id="positionDelta">0.00</div>
                        <div class="stat-subtitle" id="positionCount">0‰∏™‰ªì‰Ωç</div>
                    </div>
                    <div class="stat-card">
                        <h3>ËÆ¢ÂçïÊï∞Èáè</h3>
                        <div class="value" id="orderCount">0</div>
                        <div class="stat-subtitle">ËÆ¢ÂçïÊó†DeltaÂÄº</div>
                    </div>
                    <div class="stat-card">
                        <h3>ËÆ∞ÂΩïÊï∞Èáè</h3>
                        <div class="value" id="recordCount">0</div>
                        <div class="stat-subtitle" id="recordBreakdown">‰ªì‰Ωç: 0 | ËÆ¢Âçï: 0</div>
                    </div>
                </div>

                <!-- Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑ‰ªì‰ΩçËÆ∞ÂΩï -->
                <div class="section">
                    <div class="section-title">
                        üìä Êï∞ÊçÆÂ∫ì‰ªì‰ΩçËÆ∞ÂΩï
                        <div style="float: right;">
                            <button class="btn btn-primary" data-action="refresh-all" id="refreshAllBtn">
                                üîÑ Âà∑Êñ∞ÊâÄÊúâ
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="positionRecordsTable">
                            <thead>
                                <tr>
                                    <th>Áä∂ÊÄÅ</th>
                                    <th>ÂêàÁ∫¶ÂêçÁß∞</th>
                                    <th>ÁõÆÊ†áDelta</th>
                                    <th>Áßª‰ªìDelta</th>
                                    <th>ÊúÄÂ∞èÂà∞ÊúüÂ§©Êï∞</th>
                                    <th>DeltaÂπ≥ÂùáÂÄº</th>
                                    <th>TV_ID</th>
                                    <th>ÂàõÂª∫Êó∂Èó¥</th>
                                    <th>Êõ¥Êñ∞Êó∂Èó¥</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑËÆ¢ÂçïËÆ∞ÂΩï -->
                <div class="section">
                    <div class="section-title">
                        üìã Êï∞ÊçÆÂ∫ìËÆ¢ÂçïËÆ∞ÂΩï
                    </div>
                    <div class="table-container">
                        <table id="orderRecordsTable">
                            <thead>
                                <tr>
                                    <th>Áä∂ÊÄÅ</th>
                                    <th>ËÆ¢ÂçïID</th>
                                    <th>ÂêàÁ∫¶ÂêçÁß∞</th>
                                    <th>ÁõÆÊ†áDelta</th>
                                    <th>Áßª‰ªìDelta</th>
                                    <th>ÊúÄÂ∞èÂà∞ÊúüÂ§©Êï∞</th>
                                    <th>TV_ID</th>
                                    <th>ÂàõÂª∫Êó∂Èó¥</th>
                                    <th>Êõ¥Êñ∞Êó∂Èó¥</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- ÂÆûÈôÖ‰ªì‰Ωç -->
                <div class="section">
                    <div class="section-title">
                        üè¶ ÂÆûÈôÖ‰ªì‰Ωç (ÊâÄÊúâÂìÅÁßçÊúüÊùÉ)
                        <div style="float: right;">
                            <button class="btn btn-primary" data-action="refresh-live" id="refreshBtn">
                                üîÑ Âà∑Êñ∞
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table id="positionsTable">
                            <thead>
                                <tr>
                                    <th>ÂêàÁ∫¶ÂêçÁß∞</th>
                                    <th>Êï∞Èáè</th>
                                    <th>ÊñπÂêë</th>
                                    <th>Âπ≥Âùá‰ª∑Ê†º</th>
                                    <th>Ê†áËÆ∞‰ª∑Ê†º</th>
                                    <th>DeltaÂÄº</th>
                                    <th>DeltaÂπ≥ÂùáÂÄº</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <!-- Êú™Êàê‰∫§ËÆ¢Âçï -->
                <div class="section">
                    <div class="section-title">
                        üìã Êú™Êàê‰∫§ËÆ¢Âçï (Êú™ËÆ∞ÂΩïÂú®Êï∞ÊçÆÂ∫ì‰∏≠)
                    </div>
                    <div class="table-container">
                        <table id="ordersTable">
                            <thead>
                                <tr>
                                    <th>ËÆ¢ÂçïID</th>
                                    <th>ÂêàÁ∫¶ÂêçÁß∞</th>
                                    <th>ÊñπÂêë</th>
                                    <th>Êï∞Èáè</th>
                                    <th>‰ª∑Ê†º</th>
                                    <th>Á±ªÂûã</th>
                                    <th>Êìç‰Ωú</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ê∑ªÂä†/ÁºñËæëËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü -->
    <div id="recordModal" class="modal">
        <div class="modal-content">
            <span class="close" data-action="close-modal">&times;</span>
            <h2 id="modalTitle">Ê∑ªÂä†DeltaËÆ∞ÂΩï</h2>
            <form id="recordForm">
                <div class="form-group">
                    <label for="instrumentName">ÂêàÁ∫¶ÂêçÁß∞:</label>
                    <input type="text" id="instrumentName" required>
                </div>
                <div class="form-group">
                    <label for="targetDeltaValue">ÁõÆÊ†áDeltaÂÄº:</label>
                    <input type="number" id="targetDeltaValue" step="0.01" min="-1" max="1" required>
                </div>
                <div class="form-group">
                    <label for="tvId">TV_ID:</label>
                    <input type="number" id="tvId" required>
                </div>
                <div class="form-group">
                    <label for="recordType">ËÆ∞ÂΩïÁ±ªÂûã:</label>
                    <select id="recordType" required>
                        <option value="position">‰ªì‰Ωç</option>
                        <option value="order">ËÆ¢Âçï</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="orderId">ËÆ¢ÂçïID (ÂèØÈÄâ):</label>
                    <input type="text" id="orderId">
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-danger" data-action="close-modal">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-success">‰øùÂ≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Âø´ÈÄüÊ∑ªÂä†Ê®°ÊÄÅÊ°Ü -->
    <div id="quickAddModal" class="modal">
        <div class="modal-content">
            <span class="close" data-action="close-quick-add">&times;</span>
            <h2 id="quickAddTitle">Ê∑ªÂä†Âà∞Êï∞ÊçÆÂ∫ì</h2>
            <form id="quickAddForm">
                <div class="form-group">
                    <label for="quickInstrumentName">ÂêàÁ∫¶ÂêçÁß∞:</label>
                    <input type="text" id="quickInstrumentName" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group" id="quickTargetDeltaGroup">
                    <label for="quickTargetDeltaValue">ÁõÆÊ†áDeltaÂÄº <span style="color: red;">*</span>:</label>
                    <input type="number" id="quickTargetDeltaValue" step="0.0001" min="-1" max="1" placeholder="ËØ∑ËæìÂÖ•ÁõÆÊ†áDeltaÂÄº (-1Âà∞1‰πãÈó¥)" required>
                    <small style="color: #666; font-size: 12px;">‰ªì‰ΩçÂíåËÆ¢ÂçïÈÉΩÈúÄË¶ÅËÆæÁΩÆÁõÆÊ†áDeltaÂÄº</small>
                </div>
                <div class="form-group" id="quickMovePositionDeltaGroup">
                    <label for="quickMovePositionDeltaValue">Áßª‰ªìDeltaÂÄº <span style="color: red;">*</span>:</label>
                    <input type="number" id="quickMovePositionDeltaValue" step="0.0001" min="-1" max="1" placeholder="ËØ∑ËæìÂÖ•Áßª‰ªìDeltaÂÄº (-1Âà∞1‰πãÈó¥)" required>
                    <small style="color: #666; font-size: 12px;">‰ªì‰ΩçÂíåËÆ¢ÂçïÈÉΩÈúÄË¶ÅËÆæÁΩÆÁßª‰ªìDeltaÂÄº</small>
                </div>
                <div class="form-group">
                    <label for="quickMinExpireDays">ÊúÄÂ∞èÂà∞ÊúüÂ§©Êï∞ (ÂèØÁïôÁ©∫):</label>
                    <input type="number" id="quickMinExpireDays" min="1" step="1" placeholder="ËØ∑ËæìÂÖ•ÊúÄÂ∞èÂà∞ÊúüÂ§©Êï∞ (Â§ß‰∫é0ÁöÑÊï¥Êï∞ÔºåÂèØÁïôÁ©∫)">
                    <small style="color: #666; font-size: 12px;">Áî®‰∫éÊúüÊùÉÈÄâÊã©ÁöÑÊúÄÂ∞èÂà∞ÊúüÂ§©Êï∞ÔºåÁïôÁ©∫Ë°®Á§∫‰∏çÈôêÂà∂</small>
                </div>
                <div class="form-group">
                    <label for="quickTvId">TV_ID (ÂèØÁïôÁ©∫):</label>
                    <input type="number" id="quickTvId" placeholder="ÂèØÈÄâÁöÑTradingView‰ø°Âè∑ID">
                </div>
                <div class="form-group" id="quickOrderIdGroup" style="display: none;">
                    <label for="quickOrderId">ËÆ¢ÂçïID:</label>
                    <input type="text" id="quickOrderId" readonly style="background: #f5f5f5;">
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-danger" data-action="close-quick-add">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-success">Ê∑ªÂä†Âà∞Êï∞ÊçÆÂ∫ì</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ÁºñËæëËÆ∞ÂΩïÊ®°ÊÄÅÊ°Ü -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" data-action="close-edit">&times;</span>
            <h2 id="editModalTitle">ÁºñËæëËÆ∞ÂΩï</h2>
            <form id="editForm">
                <div class="form-group">
                    <label for="editInstrumentName">ÂêàÁ∫¶ÂêçÁß∞:</label>
                    <input type="text" id="editInstrumentName" readonly style="background: #f5f5f5;">
                </div>
                <div class="form-group" id="editTargetDeltaGroup">
                    <label for="editTargetDeltaValue">ÁõÆÊ†áDeltaÂÄº:</label>
                    <input type="number" id="editTargetDeltaValue" step="0.0001" min="-1" max="1" required>
                </div>
                <div class="form-group" id="editMovePositionDeltaGroup">
                    <label for="editMovePositionDeltaValue">Áßª‰ªìDeltaÂÄº:</label>
                    <input type="number" id="editMovePositionDeltaValue" step="0.0001" min="-1" max="1" required>
                </div>
                <div class="form-group">
                    <label for="editMinExpireDays">ÊúÄÂ∞èÂà∞ÊúüÂ§©Êï∞ (ÂèØÁïôÁ©∫):</label>
                    <input type="number" id="editMinExpireDays" min="1" step="1" placeholder="ÁïôÁ©∫Ë°®Á§∫‰∏çÈôêÂà∂">
                </div>
                <div class="form-group">
                    <label for="editTvId">TV_ID (ÂèØÁïôÁ©∫):</label>
                    <input type="number" id="editTvId" placeholder="ÂèØÈÄâÁöÑTradingView‰ø°Âè∑ID">
                </div>
                <div class="form-group" id="editOrderIdGroup" style="display: none;">
                    <label for="editOrderId">ËÆ¢ÂçïID:</label>
                    <input type="text" id="editOrderId" readonly style="background: #f5f5f5;">
                </div>
                <div style="text-align: right; margin-top: 30px;">
                    <button type="button" class="btn btn-danger" data-action="close-edit">ÂèñÊ∂à</button>
                    <button type="submit" class="btn btn-success">‰øùÂ≠ò</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Âà∑Êñ∞ÊåâÈíÆ -->
    <button class="refresh-btn" data-action="load-data" title="Âà∑Êñ∞Êï∞ÊçÆ">
        üîÑ
    </button>

    <script>
        // ÂàõÂª∫Áªü‰∏ÄÁöÑ HTTP ÂÆ¢Êà∑Á´ØÔºàÊîØÊåÅ axios Âíå fetch Â§áÁî®ÊñπÊ°àÔºâ
        const httpClient = {
            async get(url) {
                if (typeof axios !== 'undefined') {
                    return await axios.get(url);
                } else {
                    console.warn('axios Êú™Âä†ËΩΩÔºå‰ΩøÁî® fetch Â§áÁî®ÊñπÊ°à');
                    const response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return { data: await response.json() };
                }
            },

            async post(url, data) {
                if (typeof axios !== 'undefined') {
                    return await axios.post(url, data);
                } else {
                    console.warn('axios Êú™Âä†ËΩΩÔºå‰ΩøÁî® fetch Â§áÁî®ÊñπÊ°à');
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return { data: await response.json() };
                }
            },

            async put(url, data) {
                if (typeof axios !== 'undefined') {
                    return await axios.put(url, data);
                } else {
                    console.warn('axios Êú™Âä†ËΩΩÔºå‰ΩøÁî® fetch Â§áÁî®ÊñπÊ°à');
                    const response = await fetch(url, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return { data: await response.json() };
                }
            }
        };

        // Â¶ÇÊûú axios Âä†ËΩΩÊàêÂäüÔºåÈÖçÁΩÆÈªòËÆ§ËÆæÁΩÆ
        setTimeout(() => {
            if (typeof axios !== 'undefined') {
                axios.defaults.timeout = 30000; // 30ÁßíË∂ÖÊó∂
                axios.defaults.headers.common['Content-Type'] = 'application/json';

                // axios ÂìçÂ∫îÊã¶Êà™Âô®ÔºåÁªü‰∏ÄÂ§ÑÁêÜÈîôËØØ
                axios.interceptors.response.use(
                    response => response,
                    error => {
                        if (error.response) {
                            // ÊúçÂä°Âô®ËøîÂõûÈîôËØØÁä∂ÊÄÅÁ†Å
                            let message = error.response.data?.message || `HTTP ${error.response.status}: ${error.response.statusText}`;

                            // ÁâπÊÆäÂ§ÑÁêÜË¥¶Êà∑‰∏çÂ≠òÂú®ÁöÑÈîôËØØ
                            if (error.response.status === 404 && message.includes('Account not found')) {
                                const accountName = message.split(': ')[1];
                                message = `Ë¥¶Êà∑ "${accountName}" ‰∏çÂ≠òÂú®„ÄÇÂèØÁî®Ë¥¶Êà∑: ${availableAccounts.join(', ')}`;
                            }

                            throw new Error(message);
                        } else if (error.request) {
                            // ËØ∑Ê±ÇÂèëÂá∫‰ΩÜÊ≤°ÊúâÊî∂Âà∞ÂìçÂ∫î
                            throw new Error('ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÊàñÊúçÂä°Âô®Áä∂ÊÄÅ');
                        } else {
                            // ÂÖ∂‰ªñÈîôËØØ
                            throw new Error(error.message);
                        }
                    }
                );
                console.log('axios ÈÖçÁΩÆÂÆåÊàê');
            }
        }, 1000); // Á≠âÂæÖ1ÁßíÁ°Æ‰øù axios Âä†ËΩΩÂÆåÊàê

        // ÂÖ®Â±ÄÂèòÈáè
        let currentAccount = '';
        let deltaRecords = [];
        let livePositions = [];
        let liveOrders = [];
        let editingRecordId = null;
        let validatedRecords = []; // Â≠òÂÇ®È™åËØÅÂêéÁöÑËÆ∞ÂΩï

        // ÂèØÁî®Ë¥¶Êà∑ÂàóË°® - ‰ªéAPIÂä®ÊÄÅËé∑Âèñ
        let availableAccounts = [];

        // È°µÈù¢Âä†ËΩΩÊó∂ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', async function() {
            // ÊòæÁ§∫ÂàùÂßãÂåñÁä∂ÊÄÅ
            showLoading('Ê≠£Âú®ÂàùÂßãÂåñË¥¶Êà∑ÂàóË°®...');

            // ÂÖàÂä†ËΩΩË¥¶Êà∑ÂàóË°®ÔºåÂÜçÂ§ÑÁêÜURLÂèÇÊï∞
            await loadAccounts();

            // ‰ªéURLÂèÇÊï∞Ëé∑ÂèñË¥¶Êà∑ID
            const urlParams = new URLSearchParams(window.location.search);
            const accountId = urlParams.get('account');
            if (accountId) {
                // Ê£ÄÊü•Ë¥¶Êà∑ÊòØÂê¶Â≠òÂú®
                if (availableAccounts.length > 0 && availableAccounts.includes(accountId)) {
                    document.getElementById('accountSelect').value = accountId;
                    selectAccount(accountId);
                } else if (availableAccounts.length > 0) {
                    // Ë¥¶Êà∑‰∏çÂ≠òÂú®ÔºåÊòæÁ§∫ÈîôËØØÂπ∂Ê∏ÖÁêÜURL
                    showError(`URL‰∏≠ÊåáÂÆöÁöÑË¥¶Êà∑ "${accountId}" ‰∏çÂ≠òÂú®„ÄÇÂèØÁî®Ë¥¶Êà∑: ${availableAccounts.join(', ')}`);
                    const url = new URL(window.location);
                    url.searchParams.delete('account');
                    window.history.replaceState({}, '', url);
                } else {
                    // Ê≤°ÊúâÂèØÁî®Ë¥¶Êà∑ÔºåÊ∏ÖÁêÜURL‰ΩÜ‰∏çÊòæÁ§∫Ë¥¶Êà∑‰∏çÂ≠òÂú®ÁöÑÈîôËØØ
                    const url = new URL(window.location);
                    url.searchParams.delete('account');
                    window.history.replaceState({}, '', url);
                }
            }

            // Ê∑ªÂä†ÈîÆÁõòÂø´Êç∑ÈîÆ
            document.addEventListener('keydown', function(e) {
                // Ctrl+R Êàñ F5: Âà∑Êñ∞ÂÆûÊó∂Êï∞ÊçÆ
                if ((e.ctrlKey && e.key === 'r') || e.key === 'F5') {
                    e.preventDefault();
                    if (currentAccount) {
                        refreshLiveData();
                    }
                }
                // Ctrl+Shift+R: Âà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ
                if (e.ctrlKey && e.shiftKey && e.key === 'R') {
                    e.preventDefault();
                    if (currentAccount) {
                        refreshAllData();
                    }
                }
            });

            // ‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÂô®Â∑≤ÁªèÂ§ÑÁêÜ‰∫ÜÊâÄÊúâÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂Ôºå‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÁöÑ‰∫ã‰ª∂ÁõëÂê¨Âô®
            setTimeout(() => {

                // Áªü‰∏ÄÁöÑ‰∫ã‰ª∂ÂßîÊâòÂ§ÑÁêÜÂô®
                document.addEventListener('click', function(e) {
                    const target = e.target;
                    const action = target.getAttribute('data-action');

                    if (!action) return;

                    console.log('üéØ Ê£ÄÊµãÂà∞ÊåâÈíÆÁÇπÂáª:', action);

                    try {
                        switch (action) {
                            case 'edit':
                                const recordId = target.getAttribute('data-record-id');
                                editRecord(parseInt(recordId));
                                break;

                            case 'delete':
                                const deleteRecordId = target.getAttribute('data-record-id');
                                deleteRecord(parseInt(deleteRecordId));
                                break;

                            case 'add-position':
                                const instrumentName = target.getAttribute('data-instrument');
                                addPositionToDatabase(instrumentName);
                                break;

                            case 'add-order':
                                const orderId = target.getAttribute('data-order-id');
                                const orderInstrument = target.getAttribute('data-instrument');
                                addOrderToDatabase(orderId, orderInstrument);
                                break;

                            case 'refresh-all':
                                refreshAllData();
                                break;

                            case 'refresh-live':
                                refreshLiveData();
                                break;

                            case 'close-modal':
                                closeModal();
                                break;

                            case 'close-quick-add':
                                closeQuickAddModal();
                                break;

                            case 'close-edit':
                                closeEditModal();
                                break;

                            case 'load-data':
                                loadData();
                                break;

                            case 'check-record':
                                const checkRecordId = target.getAttribute('data-record-id');
                                checkRecord(parseInt(checkRecordId));
                                break;

                            default:
                                console.log('‚ö†Ô∏è Êú™Áü•ÁöÑÊìç‰Ωú:', action);
                        }
                    } catch (error) {
                        console.error('‚ùå ÊâßË°åÊìç‰ΩúÂ§±Ë¥•:', error);
                        alert('Êìç‰ΩúÂ§±Ë¥•: ' + error.message);
                    }
                });


            }, 1000);
        });





        // Âä†ËΩΩË¥¶Êà∑ÂàóË°®
        async function loadAccounts() {
            try {
                const response = await httpClient.get('/api/status');
                const data = response.data;

                // ‰ªéAPIÂìçÂ∫î‰∏≠ÊèêÂèñË¥¶Êà∑ÂàóË°®
                if (data.accounts && Array.isArray(data.accounts)) {
                    availableAccounts = data.accounts.map(acc => acc.name || acc);
                    console.log(`üìã ‰ªéAPIËé∑ÂèñÂà∞ ${availableAccounts.length} ‰∏™Ë¥¶Êà∑:`, availableAccounts);
                } else {
                    // Â¶ÇÊûúAPIÊ≤°ÊúâËøîÂõûË¥¶Êà∑ÂàóË°®ÔºåÂ∞ùËØï‰ªéÂÖ∂‰ªñÂ≠óÊÆµËé∑Âèñ
                    console.warn('APIÊú™ËøîÂõûaccountsÂ≠óÊÆµÔºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
                    availableAccounts = []; // Á©∫Êï∞ÁªÑÔºåÈÅøÂÖçÁ°¨ÁºñÁ†Å
                }

                const select = document.getElementById('accountSelect');
                select.innerHTML = '<option value="">ËØ∑ÈÄâÊã©Ë¥¶Êà∑...</option>';

                if (availableAccounts.length === 0) {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = '‚ö†Ô∏è Êú™ÊâæÂà∞ÂèØÁî®Ë¥¶Êà∑';
                    option.disabled = true;
                    select.appendChild(option);
                    showError('Êú™ÊâæÂà∞ÂèØÁî®Ë¥¶Êà∑ÔºåËØ∑Ê£ÄÊü•ÊúçÂä°Âô®ÈÖçÁΩÆ');
                } else {
                    availableAccounts.forEach(account => {
                        const option = document.createElement('option');
                        option.value = account;
                        option.textContent = account;
                        select.appendChild(option);
                    });
                }

                select.addEventListener('change', function() {
                    if (this.value) {
                        selectAccount(this.value);
                        // Êõ¥Êñ∞URLÂèÇÊï∞
                        const url = new URL(window.location);
                        url.searchParams.set('account', this.value);
                        window.history.pushState({}, '', url);
                    }
                });

            } catch (error) {
                showError('Âä†ËΩΩË¥¶Êà∑ÂàóË°®Â§±Ë¥•: ' + error.message);
            } finally {
                // Â¶ÇÊûúÊ≤°ÊúâÈÄâÊã©Ë¥¶Êà∑ÔºåÈöêËóèÂä†ËΩΩÁä∂ÊÄÅ
                if (!currentAccount) {
                    hideLoading();
                }
            }
        }

        // ÈÄâÊã©Ë¥¶Êà∑
        function selectAccount(accountId) {
            // Ê£ÄÊü•Ë¥¶Êà∑ÊòØÂê¶Â≠òÂú®
            if (!availableAccounts.includes(accountId)) {
                showError(`Ë¥¶Êà∑ "${accountId}" ‰∏çÂ≠òÂú®„ÄÇÂèØÁî®Ë¥¶Êà∑: ${availableAccounts.join(', ')}`);
                // Ê∏ÖÁ©∫URLÂèÇÊï∞
                const url = new URL(window.location);
                url.searchParams.delete('account');
                window.history.replaceState({}, '', url);
                // ÈáçÁΩÆÈÄâÊã©Ê°Ü
                document.getElementById('accountSelect').value = '';
                return;
            }

            currentAccount = accountId;
            loadData();
        }

        // Âä†ËΩΩÊï∞ÊçÆ
        async function loadData() {
            if (!currentAccount) {
                showError('ËØ∑ÂÖàÈÄâÊã©Ë¥¶Êà∑');
                return;
            }

            showLoading();
            
            try {
                // Âπ∂Ë°åÂä†ËΩΩDeltaËÆ∞ÂΩïÂíåÂÆûÊó∂Êï∞ÊçÆ
                const [deltaResponse, liveResponse] = await Promise.all([
                    httpClient.get(`/api/delta/${currentAccount}`),
                    httpClient.get(`/api/delta/${currentAccount}/live-data`)
                ]);

                const deltaData = deltaResponse.data;
                const liveData = liveResponse.data;

                if (!deltaData.success) {
                    throw new Error(deltaData.message);
                }
                
                if (!liveData.success) {
                    throw new Error(liveData.message);
                }

                // Êõ¥Êñ∞Êï∞ÊçÆ
                deltaRecords = deltaData.records || [];
                livePositions = liveData.data.positions || [];
                liveOrders = liveData.data.openOrders || [];

                // È™åËØÅËÆ∞ÂΩïÊúâÊïàÊÄß
                validateRecords();

                // Êõ¥Êñ∞ÁïåÈù¢
                updateStats(deltaData.summary);
                updatePositionRecordsTable();
                updateOrderRecordsTable();
                updatePositionsTable();
                updateOrdersTable();
                
                hideLoading();
                showSuccess('Êï∞ÊçÆÂä†ËΩΩÊàêÂäü');

            } catch (error) {
                hideLoading();
                showError('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•: ' + error.message);
            }
        }

        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats(summary) {
            // ËÆ°ÁÆóËØ¶ÁªÜÁªüËÆ°
            const positionRecords = validatedRecords.filter(record => record.record_type === 'position');
            const orderRecords = deltaRecords.filter(record => record.record_type === 'order');

            // Êõ¥Êñ∞‰∏ªË¶ÅÊï∞ÂÄº (Âè™Êúâ‰ªì‰ΩçÊúâDeltaÂÄº)
            document.getElementById('totalDelta').textContent = (summary.position_delta || 0).toFixed(4);
            document.getElementById('positionDelta').textContent = (summary.position_delta || 0).toFixed(4);
            document.getElementById('orderCount').textContent = orderRecords.length;
            document.getElementById('recordCount').textContent = summary.record_count || 0;

            // Êõ¥Êñ∞Â≠êÊ†áÈ¢ò
            document.getElementById('positionCount').textContent = `${positionRecords.length}‰∏™‰ªì‰Ωç`;
            document.getElementById('recordBreakdown').textContent = `‰ªì‰Ωç: ${positionRecords.length} | ËÆ¢Âçï: ${orderRecords.length}`;

            // ËÆæÁΩÆÈ¢úËâ≤ (Âè™Êúâ‰ªì‰ΩçDeltaÈúÄË¶ÅÈ¢úËâ≤)
            const totalElement = document.getElementById('totalDelta');
            const positionElement = document.getElementById('positionDelta');

            const positionDelta = summary.position_delta || 0;

            totalElement.className = positionDelta >= 0 ? 'value delta-positive' : 'value delta-negative';
            positionElement.className = positionDelta >= 0 ? 'value delta-positive' : 'value delta-negative';
        }

        // Êõ¥Êñ∞‰ªì‰ΩçËÆ∞ÂΩïË°®Ê†º
        function updatePositionRecordsTable() {
            // Â¶ÇÊûúvalidatedRecords‰∏∫Á©∫Ôºå‰ΩøÁî®deltaRecords‰Ωú‰∏∫ÂêéÂ§á
            const recordsToUse = validatedRecords.length > 0 ? validatedRecords : deltaRecords;

            const tbody = document.querySelector('#positionRecordsTable tbody');
            tbody.innerHTML = '';

            const positionRecords = recordsToUse.filter(record => record.record_type === 'position');

            positionRecords.forEach(record => {
                const row = document.createElement('tr');

                // Ê†πÊçÆÈ™åËØÅÁä∂ÊÄÅËÆæÁΩÆË°åÊ†∑Âºè
                if (record.is_valid === false) {
                    row.classList.add('invalid-record');
                }

                // Áä∂ÊÄÅÊòæÁ§∫
                let statusHtml = '';
                if (record.is_valid === true) {
                    statusHtml = '<span class="status-valid">‚úÖ ÊúâÊïà</span>';
                } else if (record.is_valid === false) {
                    statusHtml = `<span class="status-invalid" title="${record.validation_message}">‚ùå Êó†Êïà</span>`;
                } else {
                    statusHtml = '<span class="status-unknown">‚ùì Êú™È™åËØÅ</span>';
                }

                // ËÆ°ÁÆóDeltaÂπ≥ÂùáÂÄºÔºö‰ªéÂÆûÊó∂‰ªì‰ΩçÊï∞ÊçÆ‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑ‰ªì‰Ωç
                let deltaAverageHtml = '-';
                const livePosition = livePositions.find(pos => pos.instrument_name === record.instrument_name);
                if (livePosition) {
                    const size = livePosition.size || livePosition.amount || 0;
                    const delta = livePosition.delta || 0;

                    if (size !== 0) {
                        const deltaAverage = delta / Math.abs(size);
                        const deltaClass = deltaAverage >= 0 ? 'delta-positive' : 'delta-negative';
                        deltaAverageHtml = `<span class="${deltaClass}">${deltaAverage.toFixed(4)}</span>`;
                    }
                }

                row.innerHTML = `
                    <td>${statusHtml}</td>
                    <td>${record.instrument_name}</td>
                    <td class="${record.target_delta >= 0 ? 'delta-positive' : 'delta-negative'}">${record.target_delta.toFixed(4)}</td>
                    <td class="${(record.move_position_delta || 0) >= 0 ? 'delta-positive' : 'delta-negative'}">${(record.move_position_delta || 0).toFixed(4)}</td>
                    <td>${record.min_expire_days || '-'}</td>
                    <td>${deltaAverageHtml}</td>
                    <td>${record.tv_id || '-'}</td>
                    <td>${new Date(record.created_at).toLocaleString()}</td>
                    <td>${new Date(record.updated_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-warning" data-action="edit" data-record-id="${record.id}">ÁºñËæë</button>
                        <button class="btn btn-danger" data-action="delete" data-record-id="${record.id}">Âà†Èô§</button>
                        ${record.is_valid === false ? '<button class="btn btn-info" data-action="check-record" data-record-id="' + record.id + '">Ê£ÄÊü•</button>' : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (positionRecords.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="9" style="text-align: center; color: #7f8c8d;">ÊöÇÊó†‰ªì‰ΩçËÆ∞ÂΩï</td>';
                tbody.appendChild(row);
            }
        }

        // Êõ¥Êñ∞ËÆ¢ÂçïËÆ∞ÂΩïË°®Ê†º
        function updateOrderRecordsTable() {
            // Â¶ÇÊûúvalidatedRecords‰∏∫Á©∫Ôºå‰ΩøÁî®deltaRecords‰Ωú‰∏∫ÂêéÂ§á
            const recordsToUse = validatedRecords.length > 0 ? validatedRecords : deltaRecords;

            const tbody = document.querySelector('#orderRecordsTable tbody');
            tbody.innerHTML = '';

            const orderRecords = recordsToUse.filter(record => record.record_type === 'order');

            orderRecords.forEach(record => {
                const row = document.createElement('tr');

                // Ê†πÊçÆÈ™åËØÅÁä∂ÊÄÅËÆæÁΩÆË°åÊ†∑Âºè
                if (record.is_valid === false) {
                    row.classList.add('invalid-record');
                }

                // Áä∂ÊÄÅÊòæÁ§∫
                let statusHtml = '';
                if (record.is_valid === true) {
                    statusHtml = '<span class="status-valid">‚úÖ ÊúâÊïà</span>';
                } else if (record.is_valid === false) {
                    statusHtml = `<span class="status-invalid" title="${record.validation_message}">‚ùå Êó†Êïà</span>`;
                } else {
                    statusHtml = '<span class="status-unknown">‚ùì Êú™È™åËØÅ</span>';
                }

                row.innerHTML = `
                    <td>${statusHtml}</td>
                    <td>${record.order_id || '-'}</td>
                    <td>${record.instrument_name}</td>
                    <td class="${record.target_delta >= 0 ? 'delta-positive' : 'delta-negative'}">${record.target_delta.toFixed(4)}</td>
                    <td class="${(record.move_position_delta || 0) >= 0 ? 'delta-positive' : 'delta-negative'}">${(record.move_position_delta || 0).toFixed(4)}</td>
                    <td>${record.min_expire_days || '-'}</td>
                    <td>${record.tv_id || '-'}</td>
                    <td>${new Date(record.created_at).toLocaleString()}</td>
                    <td>${new Date(record.updated_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-warning" data-action="edit" data-record-id="${record.id}">ÁºñËæë</button>
                        <button class="btn btn-danger" data-action="delete" data-record-id="${record.id}">Âà†Èô§</button>
                        ${record.is_valid === false ? '<button class="btn btn-info" data-action="check-record" data-record-id="' + record.id + '">Ê£ÄÊü•</button>' : ''}
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (orderRecords.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="9" style="text-align: center; color: #7f8c8d;">ÊöÇÊó†ËÆ¢ÂçïËÆ∞ÂΩï</td>';
                tbody.appendChild(row);
            }
        }

        // Êõ¥Êñ∞‰ªì‰ΩçË°®Ê†º
        function updatePositionsTable() {
            const tbody = document.querySelector('#positionsTable tbody');
            tbody.innerHTML = '';

            // ËøáÊª§Âá∫Êú™ËÆ∞ÂΩïÂú®Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑ‰ªì‰Ωç
            const unrecordedPositions = livePositions.filter(position => {
                return !deltaRecords.some(record =>
                    record.instrument_name === position.instrument_name &&
                    record.record_type === 'position'
                );
            });

            unrecordedPositions.forEach(position => {
                const row = document.createElement('tr');

                // Â§ÑÁêÜÁúüÂÆûDeribitÊï∞ÊçÆÊ†ºÂºè
                const size = position.size || position.amount || 0;
                const avgPrice = position.average_price || position.average_price_usd || 0;
                const markPrice = position.mark_price || 0;
                const delta = position.delta || 0;

                // ËÆ°ÁÆóDeltaÂπ≥ÂùáÂÄºÔºö‰ªì‰ΩçÁöÑdelta / ‰ªì‰ΩçÊï∞Èáè
                let deltaAverage = 0;
                if (size !== 0) {
                    deltaAverage = delta / Math.abs(size);
                }

                row.innerHTML = `
                    <td>${position.instrument_name}</td>
                    <td>${size}</td>
                    <td>${position.direction}</td>
                    <td>${typeof avgPrice === 'number' ? avgPrice.toFixed(5) : avgPrice}</td>
                    <td>${typeof markPrice === 'number' ? markPrice.toFixed(5) : markPrice}</td>
                    <td class="${delta >= 0 ? 'delta-positive' : 'delta-negative'}">${typeof delta === 'number' ? delta.toFixed(4) : delta}</td>
                    <td class="${deltaAverage >= 0 ? 'delta-positive' : 'delta-negative'}">${deltaAverage.toFixed(4)}</td>
                    <td>
                        <button class="btn btn-success" data-action="add-position" data-instrument="${position.instrument_name}">
                            ‚ûï Ê∑ªÂä†Âà∞Êï∞ÊçÆÂ∫ì
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (unrecordedPositions.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="8" style="text-align: center; color: #7f8c8d;">ÊâÄÊúâ‰ªì‰ΩçÈÉΩÂ∑≤ËÆ∞ÂΩïÂú®Êï∞ÊçÆÂ∫ì‰∏≠</td>';
                tbody.appendChild(row);
            }
        }

        // Êõ¥Êñ∞ËÆ¢ÂçïË°®Ê†º
        function updateOrdersTable() {
            const tbody = document.querySelector('#ordersTable tbody');
            tbody.innerHTML = '';

            // ËøáÊª§Âá∫Êú™ËÆ∞ÂΩïÂú®Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑËÆ¢Âçï
            const unrecordedOrders = liveOrders.filter(order => {
                return !deltaRecords.some(record =>
                    record.order_id === order.order_id
                );
            });

            unrecordedOrders.forEach(order => {
                const row = document.createElement('tr');

                // Â§ÑÁêÜÁúüÂÆûDeribitËÆ¢ÂçïÊï∞ÊçÆÊ†ºÂºè
                const orderId = order.order_id || order.id || 'N/A';
                const amount = order.amount || order.size || 0;
                const price = order.price || order.limit_price || 0;
                const orderType = order.order_type || order.type || 'unknown';

                row.innerHTML = `
                    <td>${orderId}</td>
                    <td>${order.instrument_name}</td>
                    <td>${order.direction}</td>
                    <td>${amount}</td>
                    <td>${typeof price === 'number' ? price.toFixed(5) : price}</td>
                    <td>${orderType}</td>
                    <td>
                        <button class="btn btn-success" data-action="add-order" data-order-id="${orderId}" data-instrument="${order.instrument_name}">
                            ‚ûï Ê∑ªÂä†Âà∞Êï∞ÊçÆÂ∫ì
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            if (unrecordedOrders.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = '<td colspan="7" style="text-align: center; color: #7f8c8d;">ÊâÄÊúâËÆ¢ÂçïÈÉΩÂ∑≤ËÆ∞ÂΩïÂú®Êï∞ÊçÆÂ∫ì‰∏≠</td>';
                tbody.appendChild(row);
            }
        }



        // ÁºñËæëËÆ∞ÂΩï
        function editRecord(recordId) {
            const record = deltaRecords.find(r => r.id === recordId);
            if (!record) return;

            editingRecordId = recordId;
            document.getElementById('modalTitle').textContent = 'ÁºñËæëDeltaËÆ∞ÂΩï';
            document.getElementById('instrumentName').value = record.instrument_name;
            document.getElementById('deltaValue').value = record.delta;
            document.getElementById('tvId').value = record.tv_id;
            document.getElementById('recordType').value = record.record_type;
            document.getElementById('orderId').value = record.order_id || '';
            document.getElementById('recordModal').style.display = 'block';
        }

        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal() {
            document.getElementById('recordModal').style.display = 'none';
            editingRecordId = null;
        }

        // ‰øùÂ≠òËÆ∞ÂΩï
        document.getElementById('recordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                instrument_name: document.getElementById('instrumentName').value,
                delta: parseFloat(document.getElementById('deltaValue').value),
                tv_id: parseInt(document.getElementById('tvId').value),
                record_type: document.getElementById('recordType').value,
                order_id: document.getElementById('orderId').value || null
            };

            try {
                let response;
                if (editingRecordId) {
                    // Êõ¥Êñ∞ËÆ∞ÂΩï
                    response = await httpClient.put(`/api/delta/${currentAccount}/${editingRecordId}`, formData);
                } else {
                    // ÂàõÂª∫ËÆ∞ÂΩï
                    response = await httpClient.post(`/api/delta/${currentAccount}`, formData);
                }

                const result = response.data;

                if (!result.success) {
                    throw new Error(result.message);
                }

                closeModal();
                showSuccess(editingRecordId ? 'ËÆ∞ÂΩïÊõ¥Êñ∞ÊàêÂäü' : 'ËÆ∞ÂΩïÂàõÂª∫ÊàêÂäü');
                loadData();

            } catch (error) {
                showError('‰øùÂ≠òÂ§±Ë¥•: ' + error.message);
            }
        });

        // Âà†Èô§ËÆ∞ÂΩï - Á°Æ‰øùÂú®ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.deleteRecord = async function(recordId) {
            // Ëé∑ÂèñË¶ÅÂà†Èô§ÁöÑËÆ∞ÂΩï‰ø°ÊÅØ
            const record = validatedRecords.find(r => r.id === recordId);
            if (!record) {
                showError('ËÆ∞ÂΩï‰∏çÂ≠òÂú®');
                return;
            }

            // ÊòæÁ§∫ËØ¶ÁªÜÁöÑÁ°ÆËÆ§ÂØπËØùÊ°Ü
            const confirmMessage = `Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü\n\n` +
                `ÂêàÁ∫¶: ${record.instrument_name}\n` +
                `ÁõÆÊ†áDelta: ${record.target_delta}\n` +
                `Áßª‰ªìDelta: ${record.move_position_delta || 0}\n` +
                `Á±ªÂûã: ${record.record_type === 'position' ? '‰ªì‰Ωç' : 'ËÆ¢Âçï'}\n` +
                `TV_ID: ${record.tv_id}\n` +
                `ÂàõÂª∫Êó∂Èó¥: ${new Date(record.created_at).toLocaleString()}`;

            if (!confirm(confirmMessage)) return;

            try {
                console.log('üóëÔ∏è Âà†Èô§ËÆ∞ÂΩï:', recordId);

                const response = await fetch(`/api/delta/${currentAccount}/${recordId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                showSuccess(`ËÆ∞ÂΩïÂà†Èô§ÊàêÂäü (${record.instrument_name})`);
                loadData();

            } catch (error) {
                console.error('‚ùå Âà†Èô§ËÆ∞ÂΩïÂ§±Ë¥•:', error);
                showError('Âà†Èô§Â§±Ë¥•: ' + error.message);
            }
        };

        // Ê£ÄÊü•ËÆ∞ÂΩï - Á°Æ‰øùÂú®ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.checkRecord = function(recordId) {
            const record = validatedRecords.find(r => r.id === recordId);
            if (!record) {
                showError('ËÆ∞ÂΩï‰∏çÂ≠òÂú®');
                return;
            }

            let message = `ËÆ∞ÂΩïÊ£ÄÊü•ÁªìÊûú:\n\n`;
            message += `ÂêàÁ∫¶: ${record.instrument_name}\n`;
            message += `Á±ªÂûã: ${record.record_type === 'position' ? '‰ªì‰Ωç' : 'ËÆ¢Âçï'}\n`;
            message += `ÁõÆÊ†áDelta: ${record.target_delta}\n`;
            message += `Áßª‰ªìDelta: ${record.move_position_delta || 0}\n`;
            message += `TV_ID: ${record.tv_id || 'Êó†'}\n`;
            message += `ÂàõÂª∫Êó∂Èó¥: ${new Date(record.created_at).toLocaleString()}\n\n`;

            if (record.is_valid === false) {
                message += `‚ùå Áä∂ÊÄÅ: Êó†Êïà\n`;
                message += `ÂéüÂõ†: ${record.validation_message}\n\n`;
                message += `Âª∫ËÆÆÊìç‰Ωú:\n`;
                message += `1. Ê£ÄÊü•DeribitË¥¶Êà∑‰∏≠ÊòØÂê¶Â≠òÂú®ÂØπÂ∫îÁöÑ${record.record_type === 'position' ? '‰ªì‰Ωç' : 'ËÆ¢Âçï'}\n`;
                message += `2. Â¶ÇÊûú${record.record_type === 'position' ? '‰ªì‰ΩçÂ∑≤Âπ≥‰ªì' : 'ËÆ¢ÂçïÂ∑≤ÂèñÊ∂à'}ÔºåÂèØ‰ª•Âà†Èô§Ê≠§ËÆ∞ÂΩï\n`;
                message += `3. Â¶ÇÊûúÂêàÁ∫¶ÂêçÁß∞ÊúâËØØÔºåÂèØ‰ª•ÁºñËæë‰øÆÊ≠£\n`;
                message += `4. ÁÇπÂáª"Âà∑Êñ∞"ÊåâÈíÆÈáçÊñ∞È™åËØÅÊï∞ÊçÆ`;
            } else if (record.is_valid === true) {
                message += `‚úÖ Áä∂ÊÄÅ: ÊúâÊïà\n`;
                message += `Ê≠§ËÆ∞ÂΩïÂØπÂ∫îÁöÑ${record.record_type === 'position' ? '‰ªì‰Ωç' : 'ËÆ¢Âçï'}Âú®DeribitË¥¶Êà∑‰∏≠Â≠òÂú®`;
            } else {
                message += `‚ùì Áä∂ÊÄÅ: Êú™È™åËØÅ\n`;
                message += `Êó†Ê≥ïÈ™åËØÅÊ≠§ËÆ∞ÂΩïÁöÑÊúâÊïàÊÄßÔºåÂèØËÉΩÊòØÁΩëÁªúÈóÆÈ¢òÊàñAPIÈôêÂà∂`;
            }

            alert(message);
        };

        // ÂâçÁ´ØÈ™åËØÅËÆ∞ÂΩïÊúâÊïàÊÄß
        function validateRecords() {
            validatedRecords = deltaRecords.map(record => {
                let isValid = false;
                let validationMessage = '';

                if (record.record_type === 'position') {
                    // Ê£ÄÊü•‰ªì‰ΩçÊòØÂê¶Â≠òÂú®
                    const position = livePositions.find(p => p.instrument_name === record.instrument_name);
                    if (position) {
                        isValid = true;
                    } else {
                        validationMessage = '‰ªì‰Ωç‰∏çÂ≠òÂú®‰∫éË¥¶Êà∑‰∏≠';
                    }
                } else if (record.record_type === 'order') {
                    // Ê£ÄÊü•ËÆ¢ÂçïÊòØÂê¶Â≠òÂú®
                    const order = liveOrders.find(o =>
                        o.instrument_name === record.instrument_name &&
                        (o.order_id === record.order_id || o.id === record.order_id)
                    );
                    if (order) {
                        isValid = true;
                    } else {
                        validationMessage = 'ËÆ¢Âçï‰∏çÂ≠òÂú®‰∫éË¥¶Êà∑‰∏≠';
                    }
                }

                return {
                    ...record,
                    is_valid: isValid,
                    validation_message: validationMessage
                };
            });

            const validCount = validatedRecords.filter(r => r.is_valid).length;
            const invalidCount = validatedRecords.filter(r => !r.is_valid).length;
        }

        // Ê∑ªÂä†‰ªì‰ΩçÂà∞Êï∞ÊçÆÂ∫ì - Á°Æ‰øùÂú®ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.addPositionToDatabase = function(instrumentName) {
            try {
                showQuickAddModal(instrumentName, 'position');
            } catch (error) {
                console.error('‚ùå addPositionToDatabase ÈîôËØØ:', error);
                alert('Ê∑ªÂä†‰ªì‰ΩçÂ§±Ë¥•: ' + error.message);
            }
        };

        // Ê∑ªÂä†ËÆ¢ÂçïÂà∞Êï∞ÊçÆÂ∫ì - Á°Æ‰øùÂú®ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.addOrderToDatabase = function(orderId, instrumentName) {
            console.log('üéØ addOrderToDatabase Ë¢´Ë∞ÉÁî®:', orderId, instrumentName);
            try {
                showQuickAddModal(instrumentName, 'order', orderId);
            } catch (error) {
                console.error('‚ùå addOrderToDatabase ÈîôËØØ:', error);
                alert('Ê∑ªÂä†ËÆ¢ÂçïÂ§±Ë¥•: ' + error.message);
            }
        };



        // Âà∑Êñ∞ÂÆûÊó∂Êï∞ÊçÆ
        async function refreshLiveData() {

            if (!currentAccount) {
                showError('ËØ∑ÂÖàÈÄâÊã©Ë¥¶Êà∑');
                return;
            }

            const refreshBtn = document.getElementById('refreshBtn');

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            refreshBtn.disabled = true;
            refreshBtn.innerHTML = 'üîÑ Âà∑Êñ∞‰∏≠...';
            refreshBtn.style.opacity = '0.6';

            try {
                console.log(`üîÑ Âà∑Êñ∞ÊâÄÊúâÂìÅÁßçÊúüÊùÉÂÆûÊó∂Êï∞ÊçÆ...`);

                const response = await httpClient.get(`/api/delta/${currentAccount}/live-data`);
                const data = response.data;

                if (!data.success) {
                    throw new Error(data.message);
                }

                // Êõ¥Êñ∞ÂÖ®Â±ÄÂèòÈáè
                livePositions = data.data.positions || [];
                liveOrders = data.data.openOrders || [];

                // Êõ¥Êñ∞Ë°®Ê†º
                updatePositionsTable();
                updateOrdersTable();

                // ÊòæÁ§∫ËØ¶ÁªÜÁöÑÂà∑Êñ∞ÁªìÊûú
                const positionCount = livePositions.length;
                const orderCount = liveOrders.length;
                const mockMode = data.mockMode ? ' (MockÊ®°Âºè)' : '';

                showSuccess(`ÊâÄÊúâÂìÅÁßçÊúüÊùÉÂÆûÊó∂Êï∞ÊçÆÂà∑Êñ∞ÊàêÂäü${mockMode} - ‰ªì‰Ωç: ${positionCount}‰∏™, ËÆ¢Âçï: ${orderCount}‰∏™`);



            } catch (error) {
                console.error('‚ùå Âà∑Êñ∞Â§±Ë¥•:', error);
                showError(`Âà∑Êñ∞Êï∞ÊçÆÂ§±Ë¥•: ${error.message}`);
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                refreshBtn.disabled = false;
                refreshBtn.innerHTML = 'üîÑ Âà∑Êñ∞';
                refreshBtn.style.opacity = '1';
            }
        }



        // Âà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ (ÂåÖÊã¨Êï∞ÊçÆÂ∫ìËÆ∞ÂΩï)
        async function refreshAllData() {

            if (!currentAccount) {
                showError('ËØ∑ÂÖàÈÄâÊã©Ë¥¶Êà∑');
                return;
            }

            const refreshAllBtn = document.getElementById('refreshAllBtn');

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            refreshAllBtn.disabled = true;
            refreshAllBtn.innerHTML = 'üîÑ Âà∑Êñ∞‰∏≠...';
            refreshAllBtn.style.opacity = '0.6';

            try {
                console.log('üîÑ Âà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆ...');

                // ÈáçÊñ∞Âä†ËΩΩÊâÄÊúâÊï∞ÊçÆ
                await loadData();

                showSuccess('ÊâÄÊúâÊï∞ÊçÆÂà∑Êñ∞ÊàêÂäü');

            } catch (error) {
                console.error('‚ùå Âà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆÂ§±Ë¥•:', error);
                showError('Âà∑Êñ∞ÊâÄÊúâÊï∞ÊçÆÂ§±Ë¥•: ' + error.message);
            } finally {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                refreshAllBtn.disabled = false;
                refreshAllBtn.innerHTML = 'üîÑ Âà∑Êñ∞ÊâÄÊúâ';
                refreshAllBtn.style.opacity = '1';
            }
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞
        function showLoading(message = 'üîÑ Ê≠£Âú®Âä†ËΩΩÊï∞ÊçÆ...') {
            const loadingElement = document.getElementById('loadingMessage');
            loadingElement.innerHTML = `<h3>${message}</h3>`;
            loadingElement.style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingMessage').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('successMessage').style.display = 'none';
            setTimeout(() => {
                document.getElementById('errorMessage').style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            document.getElementById('successMessage').textContent = message;
            document.getElementById('successMessage').style.display = 'block';
            document.getElementById('errorMessage').style.display = 'none';
            setTimeout(() => {
                document.getElementById('successMessage').style.display = 'none';
            }, 3000);
        }

        // ÊòæÁ§∫Âø´ÈÄüÊ∑ªÂä†Ê®°ÊÄÅÊ°Ü - Á°Æ‰øùÂú®ÂÖ®Â±Ä‰ΩúÁî®Âüü
        window.showQuickAddModal = function(instrumentName, recordType, orderId = null) {
            console.log('üîÑ showQuickAddModal Ë¢´Ë∞ÉÁî®:', instrumentName, recordType, orderId);

            try {
                document.getElementById('quickInstrumentName').value = instrumentName;
                document.getElementById('quickTargetDeltaValue').value = '';
                document.getElementById('quickMovePositionDeltaValue').value = '';
                document.getElementById('quickTvId').value = '';

                const quickTargetDeltaGroup = document.getElementById('quickTargetDeltaGroup');
                const quickMovePositionDeltaGroup = document.getElementById('quickMovePositionDeltaGroup');
                const quickOrderIdGroup = document.getElementById('quickOrderIdGroup');
                const quickTargetDeltaInput = document.getElementById('quickTargetDeltaValue');
                const quickMovePositionDeltaInput = document.getElementById('quickMovePositionDeltaValue');

                if (recordType === 'order' && orderId) {
                    // ËÆ¢ÂçïËÆ∞ÂΩïÔºöÊòæÁ§∫ËÆ¢ÂçïIDÂíåÁõÆÊ†áDeltaÂ≠óÊÆµÂíåÁßª‰ªìDeltaÂ≠óÊÆµ
                    document.getElementById('quickOrderId').value = orderId;
                    quickOrderIdGroup.style.display = 'block';
                    quickTargetDeltaGroup.style.display = 'block';
                    quickMovePositionDeltaGroup.style.display = 'block';
                    quickTargetDeltaInput.value = ''; // ËÆ¢ÂçïÁõÆÊ†áDelta‰πüÈúÄË¶ÅÁî®Êà∑ËæìÂÖ•
                    quickMovePositionDeltaInput.value = ''; // ËÆ¢ÂçïÁßª‰ªìDelta‰πüÈúÄË¶ÅÁî®Êà∑ËæìÂÖ•
                    quickTargetDeltaInput.required = true;
                    quickMovePositionDeltaInput.required = true;

                    document.getElementById('quickAddTitle').textContent = 'Ê∑ªÂä†ËÆ¢ÂçïÂà∞Êï∞ÊçÆÂ∫ì';
                } else {
                    // ‰ªì‰ΩçËÆ∞ÂΩïÔºöÈöêËóèËÆ¢ÂçïIDÔºåÊòæÁ§∫ÁõÆÊ†áDeltaÂ≠óÊÆµÂíåÁßª‰ªìDeltaÂ≠óÊÆµ
                    quickOrderIdGroup.style.display = 'none';
                    quickTargetDeltaGroup.style.display = 'block';
                    quickMovePositionDeltaGroup.style.display = 'block';
                    quickTargetDeltaInput.required = true;
                    quickMovePositionDeltaInput.required = true;

                    document.getElementById('quickAddTitle').textContent = 'Ê∑ªÂä†‰ªì‰ΩçÂà∞Êï∞ÊçÆÂ∫ì';
                }

                // Â≠òÂÇ®ÂΩìÂâçÊìç‰Ωú‰ø°ÊÅØ
                window.currentQuickAdd = {
                    instrumentName: instrumentName,
                    recordType: recordType,
                    orderId: orderId
                };


                document.getElementById('quickAddModal').style.display = 'block';

            } catch (error) {
                console.error('‚ùå showQuickAddModal ÈîôËØØ:', error);
                alert('ÊòæÁ§∫Ê∑ªÂä†ÁïåÈù¢Â§±Ë¥•: ' + error.message);
            }
        };

        // ÂÖ≥Èó≠Âø´ÈÄüÊ∑ªÂä†Ê®°ÊÄÅÊ°Ü
        function closeQuickAddModal() {
            document.getElementById('quickAddModal').style.display = 'none';
            window.currentQuickAdd = null;
        }

        // Â§ÑÁêÜÂø´ÈÄüÊ∑ªÂä†Ë°®ÂçïÊèê‰∫§
        document.getElementById('quickAddForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!window.currentQuickAdd) return;

            const targetDeltaInput = document.getElementById('quickTargetDeltaValue').value;
            const movePositionDeltaInput = document.getElementById('quickMovePositionDeltaValue').value;
            const tvIdInput = document.getElementById('quickTvId').value;

            // È™åËØÅÊâÄÊúâËÆ∞ÂΩïÈÉΩÂøÖÈ°ªÊúâtarget_deltaÂÄº
            if (!targetDeltaInput.trim()) {
                showError('ÂøÖÈ°ªËæìÂÖ•ÁõÆÊ†áDeltaÂÄº');
                return;
            }

            // È™åËØÅÊâÄÊúâËÆ∞ÂΩïÈÉΩÂøÖÈ°ªÊúâmove_position_deltaÂÄº
            if (!movePositionDeltaInput.trim()) {
                showError('ÂøÖÈ°ªËæìÂÖ•Áßª‰ªìDeltaÂÄº');
                return;
            }

            const targetDeltaValue = parseFloat(targetDeltaInput);
            if (isNaN(targetDeltaValue) || targetDeltaValue < -1 || targetDeltaValue > 1) {
                showError('ÁõÆÊ†áDeltaÂÄºÂøÖÈ°ªÂú®-1Âà∞1‰πãÈó¥');
                return;
            }

            const movePositionDeltaValue = parseFloat(movePositionDeltaInput);
            if (isNaN(movePositionDeltaValue) || movePositionDeltaValue < -1 || movePositionDeltaValue > 1) {
                showError('Áßª‰ªìDeltaÂÄºÂøÖÈ°ªÂú®-1Âà∞1‰πãÈó¥');
                return;
            }

            const minExpireDaysInput = document.getElementById('quickMinExpireDays').value.trim();
            let minExpireDaysValue = null;

            if (minExpireDaysInput) {
                minExpireDaysValue = parseInt(minExpireDaysInput);
                if (isNaN(minExpireDaysValue) || minExpireDaysValue <= 0) {
                    showError('ÊúÄÂ∞èÂà∞ÊúüÂ§©Êï∞ÂøÖÈ°ªÊòØÂ§ß‰∫é0ÁöÑÊï¥Êï∞');
                    return;
                }
            }

            const tvId = tvIdInput.trim() ? parseInt(tvIdInput) : null;

            const formData = {
                instrument_name: window.currentQuickAdd.instrumentName,
                target_delta: targetDeltaValue,
                move_position_delta: movePositionDeltaValue,
                min_expire_days: minExpireDaysValue,
                tv_id: tvId,
                record_type: window.currentQuickAdd.recordType
            };

            if (window.currentQuickAdd.orderId) {
                formData.order_id = window.currentQuickAdd.orderId;
            }

            try {
                const response = await httpClient.post(`/api/delta/${currentAccount}`, formData);

                const result = response.data;

                if (!result.success) {
                    throw new Error(result.message);
                }

                const recordTypeText = window.currentQuickAdd.recordType === 'position' ? '‰ªì‰Ωç' : 'ËÆ¢Âçï';
                closeQuickAddModal();
                showSuccess(`${recordTypeText}Â∑≤Ê∑ªÂä†Âà∞Êï∞ÊçÆÂ∫ì (ÁõÆÊ†áDelta: ${targetDeltaValue}, Áßª‰ªìDelta: ${movePositionDeltaValue}, TV_ID: ${tvId})`);
                loadData();

            } catch (error) {
                showError('Ê∑ªÂä†Â§±Ë¥•: ' + error.message);
            }
        });

        // ÁºñËæëËÆ∞ÂΩï
        function editRecord(recordId) {
            const record = validatedRecords.find(r => r.id === recordId);
            if (!record) {
                showError('ËÆ∞ÂΩï‰∏çÂ≠òÂú®');
                return;
            }

            // Â°´ÂÖÖÁºñËæëË°®Âçï
            document.getElementById('editInstrumentName').value = record.instrument_name;
            document.getElementById('editTargetDeltaValue').value = record.target_delta;
            document.getElementById('editMovePositionDeltaValue').value = record.move_position_delta || 0;
            document.getElementById('editMinExpireDays').value = record.min_expire_days || '';
            document.getElementById('editTvId').value = record.tv_id || '';

            // Ê†πÊçÆËÆ∞ÂΩïÁ±ªÂûãÊòæÁ§∫/ÈöêËóèÂ≠óÊÆµ
            const editTargetDeltaGroup = document.getElementById('editTargetDeltaGroup');
            const editMovePositionDeltaGroup = document.getElementById('editMovePositionDeltaGroup');
            const editOrderIdGroup = document.getElementById('editOrderIdGroup');

            if (record.record_type === 'order') {
                // ËÆ¢ÂçïËÆ∞ÂΩïÔºöÊòæÁ§∫ÁõÆÊ†áDeltaÂ≠óÊÆµ„ÄÅÁßª‰ªìDeltaÂ≠óÊÆµÂíåËÆ¢ÂçïID
                editTargetDeltaGroup.style.display = 'block';
                editMovePositionDeltaGroup.style.display = 'block';
                editOrderIdGroup.style.display = 'block';
                document.getElementById('editOrderId').value = record.order_id || '';
            } else {
                // ‰ªì‰ΩçËÆ∞ÂΩïÔºöÊòæÁ§∫ÁõÆÊ†áDeltaÂ≠óÊÆµ„ÄÅÁßª‰ªìDeltaÂ≠óÊÆµÔºåÈöêËóèËÆ¢ÂçïID
                editTargetDeltaGroup.style.display = 'block';
                editMovePositionDeltaGroup.style.display = 'block';
                editOrderIdGroup.style.display = 'none';
            }

            // Â≠òÂÇ®ÂΩìÂâçÁºñËæëÁöÑËÆ∞ÂΩïID
            window.currentEditingRecord = record;

            // ÊòæÁ§∫ÁºñËæëÊ®°ÊÄÅÊ°Ü
            document.getElementById('editModal').style.display = 'block';
        }

        // ÂÖ≥Èó≠ÁºñËæëÊ®°ÊÄÅÊ°Ü
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            window.currentEditingRecord = null;
        }

        // Â§ÑÁêÜÁºñËæëË°®ÂçïÊèê‰∫§
        document.getElementById('editForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            if (!window.currentEditingRecord) return;

            const targetDeltaValue = parseFloat(document.getElementById('editTargetDeltaValue').value);
            const movePositionDeltaValue = parseFloat(document.getElementById('editMovePositionDeltaValue').value);
            const minExpireDaysInput = document.getElementById('editMinExpireDays').value.trim();
            const tvIdInput = document.getElementById('editTvId').value.trim();
            const tvId = tvIdInput ? parseInt(tvIdInput) : null;

            // È™åËØÅÊúÄÂ∞èÂà∞ÊúüÂ§©Êï∞
            let minExpireDaysValue = null;
            if (minExpireDaysInput) {
                minExpireDaysValue = parseInt(minExpireDaysInput);
                if (isNaN(minExpireDaysValue) || minExpireDaysValue <= 0) {
                    showError('ÊúÄÂ∞èÂà∞ÊúüÂ§©Êï∞ÂøÖÈ°ªÊòØÂ§ß‰∫é0ÁöÑÊï¥Êï∞');
                    return;
                }
            }

            const updateData = {
                tv_id: tvId,
                target_delta: targetDeltaValue,  // ‰ªì‰ΩçÂíåËÆ¢ÂçïÈÉΩÂèØ‰ª•Êõ¥Êñ∞ÁõÆÊ†áDelta
                move_position_delta: movePositionDeltaValue,  // ‰ªì‰ΩçÂíåËÆ¢ÂçïÈÉΩÂèØ‰ª•Êõ¥Êñ∞Áßª‰ªìDelta
                min_expire_days: minExpireDaysValue  // ÊúÄÂ∞èÂà∞ÊúüÂ§©Êï∞
            };

            try {
                const response = await httpClient.put(`/api/delta/${currentAccount}/${window.currentEditingRecord.id}`, updateData);

                const result = response.data;

                if (!result.success) {
                    throw new Error(result.message);
                }

                closeEditModal();
                showSuccess('ËÆ∞ÂΩïÊõ¥Êñ∞ÊàêÂäü');
                loadData();

            } catch (error) {
                showError('Êõ¥Êñ∞Â§±Ë¥•: ' + error.message);
            }
        });

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        window.onclick = function(event) {
            const recordModal = document.getElementById('recordModal');
            const quickAddModal = document.getElementById('quickAddModal');
            const editModal = document.getElementById('editModal');

            if (event.target === recordModal) {
                closeModal();
            } else if (event.target === quickAddModal) {
                closeQuickAddModal();
            } else if (event.target === editModal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>
