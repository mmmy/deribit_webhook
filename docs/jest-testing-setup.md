# Jest æµ‹è¯•æ¡†æ¶é…ç½®æ€»ç»“

## æ¦‚è¿°

æœ¬é¡¹ç›®å·²æˆåŠŸé…ç½®äº†Jestæµ‹è¯•æ¡†æ¶ï¼Œæ”¯æŒTypeScriptå’Œå®Œæ•´çš„æµ‹è¯•ç”Ÿæ€ç³»ç»Ÿã€‚

## å·²å®Œæˆçš„é…ç½®

### 1. ä¾èµ–å®‰è£…
```bash
npm install --save-dev jest @types/jest ts-jest supertest @types/supertest
```

### 2. Jesté…ç½®æ–‡ä»¶ (`jest.config.js`)
- âœ… ä½¿ç”¨ts-jesté¢„è®¾æ”¯æŒTypeScript
- âœ… é…ç½®æ¨¡å—è·¯å¾„æ˜ å°„ (`moduleNameMapper`)
- âœ… è®¾ç½®æµ‹è¯•æ–‡ä»¶åŒ¹é…æ¨¡å¼
- âœ… é…ç½®è¦†ç›–ç‡æ”¶é›†
- âœ… æ·»åŠ æµ‹è¯•è®¾ç½®æ–‡ä»¶
- âœ… å¯ç”¨å¥æŸ„æ£€æµ‹å’Œå†…å­˜æ³„æ¼æ£€æµ‹

### 3. æµ‹è¯•è„šæœ¬ (`package.json`)
```json
{
  "test": "jest",
  "test:watch": "jest --watch",
  "test:coverage": "jest --coverage",
  "test:verbose": "jest --verbose",
  "test:ci": "jest --ci --coverage --watchAll=false"
}
```

### 4. TypeScripté…ç½®æ›´æ–°
- âœ… æ·»åŠ Jestç±»å‹æ”¯æŒ
- âœ… ä»æ’é™¤åˆ—è¡¨ä¸­ç§»é™¤æµ‹è¯•æ–‡ä»¶

### 5. æµ‹è¯•è®¾ç½®æ–‡ä»¶ (`tests/setup.ts`)
- âœ… å…¨å±€æµ‹è¯•ç¯å¢ƒé…ç½®
- âœ… ç¯å¢ƒå˜é‡è®¾ç½®
- âœ… æ¨¡æ‹Ÿæ§åˆ¶å°æ–¹æ³•
- âœ… æµ‹è¯•æ¸…ç†æœºåˆ¶

## å½“å‰æµ‹è¯•çŠ¶æ€

### âœ… é€šè¿‡çš„æµ‹è¯•å¥—ä»¶

1. **Price Correction Utils** (`tests/services/price-correction.test.ts`)
   - æµ‹è¯•ä»·æ ¼ä¿®æ­£å·¥å…·å‡½æ•°
   - è¦†ç›–tick sizeè®¡ç®—å’Œä»·æ ¼ä¿®æ­£é€»è¾‘
   - 6ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

2. **Response Formatter Utils** (`tests/utils/response-formatter.test.ts`)
   - æµ‹è¯•å“åº”æ ¼å¼åŒ–å·¥å…·
   - è¦†ç›–æˆåŠŸå’Œé”™è¯¯å“åº”å¤„ç†
   - 5ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

3. **Webhook Logic** (`tests/services/webhook-logic.test.ts`)
   - æµ‹è¯•webhookæ ¸å¿ƒé€»è¾‘
   - è¦†ç›–æ³¨é‡Šè¿‡æ»¤å’Œè½½è·éªŒè¯
   - 6ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡

### ğŸ“Š æµ‹è¯•è¦†ç›–ç‡
- **æ€»ä½“è¦†ç›–ç‡**: 1.73% (ä»…é’ˆå¯¹å·²æµ‹è¯•çš„æ¨¡å—)
- **Utilsæ¨¡å—**: 31.69% è¦†ç›–ç‡
  - price-correction.ts: 55.35%
  - response-formatter.ts: 46.55%

## æµ‹è¯•å‘½ä»¤

### åŸºæœ¬æµ‹è¯•å‘½ä»¤
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
npm test

# ç›‘è§†æ¨¡å¼è¿è¡Œæµ‹è¯•
npm run test:watch

# ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage

# è¯¦ç»†è¾“å‡ºæ¨¡å¼
npm run test:verbose

# CIç¯å¢ƒè¿è¡Œ
npm run test:ci
```

### å•ç‹¬è¿è¡Œæµ‹è¯•
```bash
# è¿è¡Œç‰¹å®šæµ‹è¯•æ–‡ä»¶
npx jest tests/services/price-correction.test.ts

# è¿è¡Œç‰¹å®šæµ‹è¯•ç›®å½•
npx jest tests/services/

# è¿è¡ŒåŒ¹é…æ¨¡å¼çš„æµ‹è¯•
npx jest --testNamePattern="should ignore"
```

## æµ‹è¯•æ–‡ä»¶ç»“æ„

```
tests/
â”œâ”€â”€ setup.ts                    # å…¨å±€æµ‹è¯•è®¾ç½®
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ price-correction.test.ts # ä»·æ ¼ä¿®æ­£å·¥å…·æµ‹è¯•
â”‚   â””â”€â”€ webhook-logic.test.ts   # Webhooké€»è¾‘æµ‹è¯•
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ response-formatter.test.ts # å“åº”æ ¼å¼åŒ–æµ‹è¯•
â””â”€â”€ routes/                    # è·¯ç”±æµ‹è¯•ç›®å½•ï¼ˆå¾…æ‰©å±•ï¼‰
```

## æµ‹è¯•æœ€ä½³å®è·µ

### 1. å•å…ƒæµ‹è¯•
- æµ‹è¯•çº¯å‡½æ•°å’Œå·¥å…·æ–¹æ³•
- ä½¿ç”¨mocké¿å…å¤–éƒ¨ä¾èµ–
- è¦†ç›–è¾¹ç•Œæƒ…å†µ

### 2. é›†æˆæµ‹è¯•
- æµ‹è¯•APIç«¯ç‚¹
- ä½¿ç”¨supertestè¿›è¡ŒHTTPæµ‹è¯•
- éªŒè¯å®Œæ•´çš„å·¥ä½œæµç¨‹

### 3. æµ‹è¯•ç»„ç»‡
- æŒ‰åŠŸèƒ½æ¨¡å—ç»„ç»‡æµ‹è¯•æ–‡ä»¶
- ä½¿ç”¨describeå’Œitè¿›è¡Œå±‚æ¬¡åŒ–æè¿°
- ä¿æŒæµ‹è¯•ç”¨ä¾‹ç‹¬ç«‹å’Œå¯é‡å¤

## ä¸‹ä¸€æ­¥å»ºè®®

### 1. æ‰©å±•æµ‹è¯•è¦†ç›–
- [ ] æ·»åŠ æ›´å¤šå·¥å…·å‡½æ•°çš„å•å…ƒæµ‹è¯•
- [ ] åˆ›å»ºAPIè·¯ç”±çš„é›†æˆæµ‹è¯•
- [ ] æ·»åŠ æ•°æ®åº“æ“ä½œçš„æµ‹è¯•

### 2. æé«˜è¦†ç›–ç‡
- [ ] ç›®æ ‡è¾¾åˆ°70%ä»¥ä¸Šçš„ä»£ç è¦†ç›–ç‡
- [ ] é‡ç‚¹æµ‹è¯•æ ¸å¿ƒä¸šåŠ¡é€»è¾‘
- [ ] æ·»åŠ é”™è¯¯å¤„ç†æµ‹è¯•

### 3. æµ‹è¯•è‡ªåŠ¨åŒ–
- [ ] é…ç½®GitHub Actions CI/CD
- [ ] æ·»åŠ è¦†ç›–ç‡é—¨æ§›æ£€æŸ¥
- [ ] é›†æˆæ€§èƒ½æµ‹è¯•

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **å†…å­˜æ³„æ¼**
   - ä½¿ç”¨`--detectOpenHandles`æ£€æµ‹
   - ç¡®ä¿æ­£ç¡®æ¸…ç†èµ„æº
   - é¿å…åœ¨æµ‹è¯•ä¸­åˆ›å»ºå®Œæ•´åº”ç”¨

2. **è¶…æ—¶é—®é¢˜**
   - å¢åŠ `testTimeout`é…ç½®
   - æ£€æŸ¥å¼‚æ­¥æ“ä½œ
   - ä½¿ç”¨mocké¿å…é•¿æ—¶é—´è¿è¡Œçš„æ“ä½œ

3. **TypeScripté”™è¯¯**
   - ç¡®ä¿tsconfig.jsonåŒ…å«æµ‹è¯•æ–‡ä»¶
   - æ£€æŸ¥ç±»å‹å®šä¹‰
   - ä½¿ç”¨æ­£ç¡®çš„å¯¼å…¥è·¯å¾„

## ç»“è®º

Jestæµ‹è¯•æ¡†æ¶å·²æˆåŠŸé…ç½®å¹¶è¿è¡Œæ­£å¸¸ã€‚å½“å‰æœ‰18ä¸ªæµ‹è¯•ç”¨ä¾‹å…¨éƒ¨é€šè¿‡ï¼Œä¸ºé¡¹ç›®æä¾›äº†å¯é çš„æµ‹è¯•åŸºç¡€ã€‚å»ºè®®ç»§ç»­æ‰©å±•æµ‹è¯•è¦†ç›–èŒƒå›´ï¼Œæé«˜ä»£ç è´¨é‡å’Œå¯é æ€§ã€‚